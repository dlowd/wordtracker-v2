import{createClient as Ia}from"https://esm.sh/@supabase/supabase-js@2";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function a(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=a(r);fetch(r.href,n)}})();const Te=Object.freeze({newLayout:!0,newWordEntry:!0,newProgressSummary:!0,customizableStats:!0,rewardsSystem:!0,bookComparisons:!0}),q=t=>!!Te[t],ia="wordtracker:v2:entries",He={entryAdded:"wordtracker:entry-added",entryUndone:"wordtracker:entry-undone"},Qe=()=>({total:0,entries:[]}),Ra=()=>{if(typeof window>"u"||!window.localStorage)return Qe();try{const t=window.localStorage.getItem(ia);if(!t)return Qe();const e=JSON.parse(t);return typeof e!="object"||e===null?Qe():{total:Number.isFinite(e.total)?e.total:0,entries:Array.isArray(e.entries)?e.entries:[]}}catch(t){return console.warn("Failed to parse stored entries; clearing cache.",t),Qe()}},Ma=t=>{typeof window>"u"||!window.localStorage||window.localStorage.setItem(ia,JSON.stringify(t))},dt=(t,e)=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(t,{detail:e}))},b=Ra(),Oa=()=>({total:b.total,entries:b.entries.map(t=>({...t}))}),lt=t=>t<0?0:t,da=({mode:t,delta:e,previousTotal:a,newTotal:s,timestamp:r})=>({id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,mode:t,delta:e,previousTotal:a,newTotal:s,timestamp:Number.isFinite(r)?r:Date.now()}),Ye=()=>{Ma(b)},xa=(t={})=>{const e=Number.isFinite(t.total)?t.total:0,a=Array.isArray(t.entries)?t.entries:[];b.total=lt(e),b.entries=a.map(s=>({...s,timestamp:Number.isFinite(s?.timestamp)?s.timestamp:Date.now(),delta:Number.isFinite(s?.delta)?s.delta:0,previousTotal:Number.isFinite(s?.previousTotal)?s.previousTotal:0,newTotal:Number.isFinite(s?.newTotal)?s.newTotal:b.total})),Ye(),dt(He.entryAdded,{total:b.total,entry:null})},qa=async t=>{const e=Number.isFinite(t)?t:0,a=b.total;let s=a+e;s=lt(s);const r=da({mode:"add",delta:e,previousTotal:a,newTotal:s});b.total=s,b.entries.push(r),Ye();const n={total:b.total,entry:r};return dt(He.entryAdded,n),n},Ga=async t=>{const e=Number.isFinite(t)?t:b.total,a=lt(e),s=b.total,r=a-s;if(r===0)return{total:b.total,entry:null};const n=da({mode:"set",delta:r,previousTotal:s,newTotal:a});b.total=a,b.entries.push(n),Ye();const o={total:b.total,entry:n};return dt(He.entryAdded,o),o},Ba=async()=>{if(b.entries.length===0)return{total:b.total,entry:null};const t=b.entries.pop();b.total=lt(t.previousTotal),Ye();const e={total:b.total,entry:t};return dt(He.entryUndone,e),e},g={events:He,getSnapshot(){return Oa()},async addWords(t){return qa(t)},async setTotal(t){return Ga(t)},async undoLastEntry(){return Ba()},reset(){b.total=0,b.entries=[],Ye()},replaceState(t){xa(t)}},Xt="wordtracker:v2:entry-mode",_={idle:"Enter your words to see progress updates here.",saving:"Saving your words...",invalidNumber:"Please enter a valid number of words.",zeroDelta:"No change recorded. Enter a positive or negative number.",negativeTotal:"Total words cannot be negative. Please enter zero or a positive number.",undoUnavailable:"No previous entry to undo.",undoSuccess:"Last entry removed.",error:"Something went wrong while saving. Please try again.",modeAdd:"Add words mode: log the change since your last update.",modeSet:"Set total mode: update your running total directly."},kt=t=>t<0?0:t,xe=t=>Number(t||0).toLocaleString();class Wa{constructor({root:e,form:a,modeField:s,countField:r,statusField:n,updateButton:o,undoButton:d,store:l=g,eventTarget:c=window}){this.root=e,this.form=a,this.modeField=s,this.countField=r,this.statusField=n,this.updateButton=o,this.undoButton=d,this.store=l,this.eventTarget=c,this.state={totalWords:0,lastEntry:null},this.isProcessing=!1,this.boundOnSubmit=this.handleSubmit.bind(this),this.boundOnUndo=this.handleUndo.bind(this),this.boundOnModeChange=this.handleModeChange.bind(this)}init(){if(!this.form||!this.modeField||!this.countField)return;const e=this.store.getSnapshot();this.state.totalWords=kt(e.total),this.state.lastEntry=e.entries.length?e.entries[e.entries.length-1]:null;const a=this.loadPersistedMode()||"add";this.setMode(a,{persist:!1,announce:!1}),this.form.addEventListener("submit",this.boundOnSubmit),this.modeField.addEventListener("change",this.boundOnModeChange),this.undoButton&&this.undoButton.addEventListener("click",this.boundOnUndo),this.updateUndoAvailability(),this.state.totalWords>0?this.updateStatus("Progress synced."):this.updateStatus(_.idle)}destroy(){this.form&&this.form.removeEventListener("submit",this.boundOnSubmit),this.modeField&&this.modeField.removeEventListener("change",this.boundOnModeChange),this.undoButton&&this.undoButton.removeEventListener("click",this.boundOnUndo)}setProcessing(e){this.isProcessing=e,this.updateButton&&(this.updateButton.disabled=e),this.form&&this.form.setAttribute("aria-busy",String(e)),this.updateUndoAvailability()}updateStatus(e){this.statusField&&(this.statusField.textContent=e)}focusInput(){this.countField&&this.countField.focus()}setTotalWords(e){const a=kt(Number.isFinite(e)?e:0);this.state.totalWords=a,this.state.lastEntry=null,this.updateUndoAvailability(),this.updateStatus("Progress synced.")}getState(){return{...this.state}}getMode(){return this.getModeValue()}async handleSubmit(e){if(e.preventDefault(),this.isProcessing)return;const a=this.getModeValue(),s=Number.parseInt(this.countField.value,10);if(!Number.isFinite(s)||Number.isNaN(s)){this.updateStatus(_.invalidNumber),this.focusInput();return}a==="add"?await this.processAddMode(s):await this.processSetMode(s)}async handleUndo(){if(!this.isProcessing){if(!this.state.lastEntry){this.updateStatus(_.undoUnavailable);return}this.setProcessing(!0),this.updateStatus(_.saving);try{const e=await this.store.undoLastEntry();if(!e.entry){this.updateStatus(_.undoUnavailable);return}this.state.totalWords=e.total,this.state.lastEntry=null,this.updateStatus(`${_.undoSuccess} Total: ${xe(this.state.totalWords)}.`)}catch(e){console.error("Failed to undo last entry.",e),this.updateStatus(_.error)}finally{this.setProcessing(!1),this.updateUndoAvailability()}}}updateUndoAvailability(){if(!this.undoButton)return;const e=!!this.state.lastEntry;this.undoButton.disabled=!e||this.isProcessing}handleModeChange(e){if(this.isProcessing){this.modeField&&(this.modeField.value=this.getModeValue());return}const a=this.getModeValue();this.setMode(a)}setMode(e,{persist:a=!0,announce:s=!0}={}){const r=e==="set"?"set":"add";this.modeField&&(this.modeField.value=r),a&&this.persistMode(r),s&&this.updateStatus(r==="set"?_.modeSet:_.modeAdd)}getModeValue(){return this.modeField&&this.modeField.value==="set"?"set":"add"}loadPersistedMode(){if(typeof window>"u"||!window.localStorage)return null;try{const e=window.localStorage.getItem(Xt);return e==="set"?"set":e==="add"?"add":null}catch(e){return console.warn("Unable to read word entry mode from storage.",e),null}}persistMode(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Xt,e)}catch(a){console.warn("Unable to persist word entry mode.",a)}}async processAddMode(e){if(e===0){this.updateStatus(_.zeroDelta);return}this.setProcessing(!0),this.updateStatus(_.saving);try{const a=await this.store.addWords(e);this.state.totalWords=a.total,this.state.lastEntry=a.entry;const s=e>=0?"Added":"Removed";this.updateStatus(`${s} ${xe(Math.abs(e))} words. Total: ${xe(this.state.totalWords)}.`),this.countField&&(this.countField.value="")}catch(a){console.error("Failed to add words.",a),this.updateStatus(_.error)}finally{this.setProcessing(!1),this.updateUndoAvailability()}}async processSetMode(e){if(e<0){this.updateStatus(_.negativeTotal),this.focusInput();return}const a=this.state.totalWords,s=kt(e);if(s===a){this.updateStatus("Total unchanged.");return}this.setProcessing(!0),this.updateStatus(_.saving);try{const r=await this.store.setTotal(s);if(!r.entry){this.updateStatus("Total unchanged.");return}this.state.totalWords=r.total,this.state.lastEntry=r.entry;const n=r.entry.delta,o=n>=0?"Increased":"Decreased";this.updateStatus(`${o} total to ${xe(this.state.totalWords)} words (${n>=0?"+":"-"}${xe(Math.abs(n))}).`),this.countField&&(this.countField.value="")}catch(r){console.error("Failed to set total.",r),this.updateStatus(_.error)}finally{this.setProcessing(!1),this.updateUndoAvailability()}}}const za=()=>{const t=document.querySelector("[data-word-entry]");if(!t)return null;const e=new Wa({root:t,form:t.querySelector("[data-word-entry-form]"),modeField:t.querySelector("[data-entry-mode]"),countField:t.querySelector("[data-word-count]"),statusField:t.querySelector("[data-entry-status]"),updateButton:t.querySelector("[data-update-button]"),undoButton:t.querySelector("[data-undo-button]")});return e.init(),e},St="stat-card--success";class $a{constructor({root:e,statList:a}){this.root=e,this.statList=a,this.statItems=this.buildStatMap()}buildStatMap(){if(!this.statList)return{};const e={};return this.statList.querySelectorAll("[data-stat-id]").forEach(a=>{const s=a.dataset.statId;if(!s)return;const r=a.querySelector("[data-stat-value]");e[s]={card:a,valueEl:r}}),e}setStat(e,{value:a,emphasize:s=!1,hidden:r}={}){const n=this.statItems[e];n&&(typeof a<"u"&&n.valueEl&&(n.valueEl.textContent=a),typeof r<"u"&&(r?n.card.setAttribute("hidden",""):n.card.removeAttribute("hidden")),s?n.card.classList.add(St):n.card.classList.remove(St))}resetStats(){Object.values(this.statItems).forEach(({card:e})=>e.classList.remove(St))}getRoot(){return this.root}}const Ka=()=>{const t=document.querySelector(".sidebar");if(!t)return null;const e=t.querySelector("[data-stat-list]");return new $a({root:t,statList:e})},K=()=>{const e=new Date().getFullYear(),a=new Date(Date.UTC(e,10,1)),s=new Date(Date.UTC(e,10,30));return{id:"default-project",name:"My Novel",goal:5e4,startDate:a.toISOString().slice(0,10),endDate:s.toISOString().slice(0,10)}},la="wordtracker:v2:preferences",Z=()=>({optionalStats:{averageWords:!0,wordsRemaining:!0,bestDay:!0,currentStreak:!0,projectedFinish:!0,percentage:!0},theme:"classic",project:K(),features:{bookComparisons:!0,devFeatures:!1}}),ca=()=>{if(typeof window>"u"||!window.localStorage)return Z();try{const t=window.localStorage.getItem(la);if(!t)return Z();const e=JSON.parse(t);return{...Z(),...e,optionalStats:{...Z().optionalStats,...e.optionalStats||{}},features:{...Z().features,...e.features||{}}}}catch(t){return console.warn("Failed to parse preferences, resetting.",t),Z()}},Ja=t=>{if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(la,JSON.stringify(t))}catch(e){console.warn("Unable to persist preferences",e)}};let De=ca();const ct=()=>(De=ca(),De),ut=t=>{const e={...De};typeof t=="function"?Object.assign(e,t({...e})):typeof t=="object"&&t!==null&&Object.assign(e,t);const a=K();return De={...Z(),...e,optionalStats:{...Z().optionalStats,...e.optionalStats||{}},project:{...a,...e.project||{}},features:{...Z().features,...e.features||{}}},Ja(De),De},Va=(t,e)=>{const a=ct(),s={...a,optionalStats:{...a.optionalStats,[t]:!!e}};return ut(s),s},Ha=(t,e)=>{const a=ct(),s={...a,features:{...a.features,[t]:!!e}};return ut(s),s},ke=t=>{const a={...K(),...t||{}};return ut(s=>({...s,project:a})),a},ua=t=>{const e=typeof t=="string"?t:"classic";return ut(a=>({...a,theme:e})),e};let Be=null;const Ya=()=>{if(!Be){const t=ct();Be={...K(),...t.project||{}}}return{...Be}},Rt=t=>{const e={...K(),...t||{}};return Be=e,ke(e),{...Be}},Xa=1440*60*1e3,ha=/^(\d{4})-(\d{2})-(\d{2})$/,Se=t=>{if(t instanceof Date)return new Date(t.getTime());if(typeof t=="number"){const e=new Date(t);return Number.isNaN(e.valueOf())?null:e}if(typeof t=="string"){const e=t.trim(),a=ha.exec(e);if(a){const[,r,n,o]=a,d=new Date(Number(r),Number(n)-1,Number(o));return Number.isNaN(d.valueOf())?null:d}const s=new Date(e);return Number.isNaN(s.valueOf())?null:s}return null},w=t=>{const e=Se(t);return e?(e.setHours(0,0,0,0),e):null},Mt=(t,e)=>{const a=w(t);if(!a||!Number.isFinite(e))return null;const s=new Date(a.getTime());return s.setDate(s.getDate()+e),s},ye=(t,e)=>{const a=w(t),s=w(e);return!a||!s?0:Math.round((a.getTime()-s.getTime())/Xa)},k=t=>{const e=w(t);if(!e)return null;const a=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${a}-${s}-${r}`},Za=t=>{const e=ha.exec(t??"");if(!e)return null;const[,a,s,r]=e,n=new Date(Number(a),Number(s)-1,Number(r));return Number.isNaN(n.valueOf())?null:n},Ot=(t=[])=>{if(!t?.length)return[];const e=new Map;t.forEach(s=>{const r=k(s?.timestamp);if(!r)return;const n=e.get(r)||0,o=Number.isFinite(s?.delta)?s.delta:0;e.set(r,n+o)});let a=0;return Array.from(e.entries()).sort(([s],[r])=>s.localeCompare(r)).map(([s,r])=>(a+=r,{date:s,delta:r,cumulative:a}))},x=t=>new Intl.NumberFormat().format(Math.round(t)),Zt=t=>{const e=x(Math.abs(t));return t<0?`-${e}`:e},Qa=t=>`${Math.round(t)}%`,es=t=>t?.length?new Set(t.map(a=>k(a?.timestamp)).filter(Boolean)).size:0,ts=(t,e=new Date)=>{const a=w(t?.startDate),s=w(t?.endDate),r=w(e);if(!a||!s||!r||s<a)return{phase:"unknown",totalDays:0,dayNumber:0,daysUntilStart:0,daysRemaining:0};const n=ye(s,a)+1;if(r<a){const l=Math.max(ye(a,r),0);return{phase:"before",totalDays:n,dayNumber:0,daysUntilStart:l,daysRemaining:n}}if(r>s)return{phase:"after",totalDays:n,dayNumber:n,daysUntilStart:0,daysRemaining:0};const o=ye(r,a)+1,d=Math.max(n-o,0);return{phase:"active",totalDays:n,dayNumber:o,daysUntilStart:0,daysRemaining:d}},as=(t,e=new Date)=>{if(!t?.length)return 0;const a=k(e);return t.reduce((s,r)=>{const n=k(r?.timestamp);return n&&n===a?s+(Number.isFinite(r?.delta)?r.delta:0):s},0)},ma=(t,e,a=new Date)=>{const s=Number.isFinite(t?.total)?t.total:0,r=Array.isArray(t?.entries)?t.entries:[],n=ts(e,a),o=as(r,a),d=Number.isFinite(e?.goal)&&e.goal>0?e.goal:5e4,l=d-s,c=l,h=d>0?s/d*100:0;let m;n.phase==="before"?m=n.totalDays:n.phase==="after"?m=1:m=Math.max(n.totalDays-n.dayNumber+1,1);const y=Math.max(l,0),B=m>0?Math.ceil(y/m):0,T=n.totalDays>0?n.totalDays:m,V=T>0?d/T:0;let ae=0;n.phase==="active"?ae=n.dayNumber:n.phase==="after"?ae=n.totalDays:ae=0;const Ze=ae>0?Math.round(V*ae):0,D=s-Ze,Ie=V>0?Math.round(D/V):0,se=Ot(r),Vt=es(r);let ft=0;if(s>0){const v=w(e?.startDate),P=w(a);if(v&&P&&P>=v){const X=w(e?.endDate);let L=P;X&&P>X&&(L=X);const re=ye(L,v)+1;re>0&&(ft=Math.round(s/re))}else Vt>0&&(ft=Math.round(s/Vt))}const yt=n.totalDays>0?Math.ceil(d/n.totalDays):d;let wt=0,Ht=null;if(se.length){const v=w(e?.startDate);se.forEach(P=>{const X=P.delta;if(X>wt){wt=X;const L=w(P.date);Ht=v?Math.max(ye(L,v),0)+1:null}})}let Yt=0;if(se.length&&yt>0){const v=w(e?.startDate),P=new Map(se.map(re=>[re.date,re.delta]));let L=w(se[se.length-1].date);for(;L&&v&&L>=v;){const re=k(L);if((P.get(re)||0)>=yt)Yt+=1,L=Mt(L,-1);else break}}let bt=null;if(s>=d)bt=w(a);else if(s>0){const v=n.phase==="active"?n.dayNumber:se.length,P=v>0?s/v:0;if(P>0){const X=Math.ceil(Math.max(d-s,0)/P),L=w(a);L&&(L.setDate(L.getDate()+X),bt=L)}}let Re;if(n.phase==="before"){const v=n.daysUntilStart||0;Re=`Starts in ${v} day${v===1?"":"s"}`}else n.phase==="after"?Re="Project complete":n.phase==="unknown"?Re="Project":Re=`Day ${n.dayNumber} of ${n.totalDays}`;let Me="On track ✓",Oe="on-track";if(n.phase==="before"){const v=n.daysUntilStart||0,P=v===1?"":"s";Me=v>0?`Project starts in ${v} day${P}`:"Project starting soon",Oe="before"}else n.phase==="after"?(Me="Goal period complete",Oe="complete"):D>0?(Me=`${x(Math.abs(Ie))} day${Math.abs(Ie)===1?"":"s"} ahead ✓`,Oe="ahead"):D<0&&(Me=`${x(Math.abs(Ie))} day${Math.abs(Ie)===1?"":"s"} behind`,Oe="behind");const _a=n.phase==="active"&&o>=B&&B>0;return{totalWords:s,wordsToday:o,wordsRemaining:c,wordsPerDayRequired:B,averageWordsPerDay:ft,percentage:h,progressPercentage:h,goalWords:d,expectedWords:Ze,paceDeltaWords:D,daysAheadBehind:Ie,dailyPace:V,paceState:Oe,paceLabel:Me,requirementDays:m,highlightToday:_a,dayPhase:n,headerLabel:Re,baselineDailyGoal:yt,bestDayWords:wt,bestDayNumber:Ht,currentStreak:Yt,projectedFinishDate:bt,dailyTotals:se}},ss=t=>{const e=new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric"});let a=null;t.wordsRemaining<=0?a="Goal achieved!":t.projectedFinishDate&&t.projectedFinishDate instanceof Date&&(a=e.format(t.projectedFinishDate));const s=t.bestDayWords>0&&t.bestDayNumber?`${x(t.bestDayWords)} (Day ${t.bestDayNumber})`:"—",r=t.currentStreak>0?`${t.currentStreak} day${t.currentStreak===1?"":"s"}`:"0 days";return{wordsPerDayRequired:t.wordsPerDayRequired>0?x(t.wordsPerDayRequired):"—",wordsToday:Zt(t.wordsToday),totalWords:x(t.totalWords),percentage:Qa(t.percentage),averageWordsPerDay:t.averageWordsPerDay>0?x(t.averageWordsPerDay):"—",wordsRemaining:Zt(t.wordsRemaining),goalWords:x(t.goalWords),progressWordsLabel:`${x(t.totalWords)} / ${x(t.goalWords)} words`,paceLabel:t.paceLabel,paceState:t.paceState,bestDay:s,currentStreak:r,projectedFinish:a||"—"}},rs={ahead:"progress-summary__pace--ahead",behind:"progress-summary__pace--behind",complete:"progress-summary__pace--complete","on-track":"",before:""};class ns{constructor({root:e,percentageEl:a,barEl:s,wordsEl:r,paceEl:n}){this.root=e,this.percentageEl=a,this.barEl=s,this.wordsEl=r,this.paceEl=n,this.currentPaceClass=""}setProgress({percentage:e,wordsLabel:a,paceLabel:s,paceState:r}){if(this.percentageEl&&(this.percentageEl.textContent=e),this.barEl){const n=Number.parseFloat(typeof e=="string"?e.replace("%",""):e),o=Number.isFinite(n)?Math.max(Math.min(n,200),0):0;this.barEl.style.width=`${o}%`}if(this.wordsEl&&(this.wordsEl.textContent=a),this.paceEl){this.currentPaceClass&&(this.paceEl.classList.remove(this.currentPaceClass),this.currentPaceClass="");const n=rs[r]||"";n&&(this.paceEl.classList.add(n),this.currentPaceClass=n),this.paceEl.textContent=s}}}const os=()=>{const t=document.querySelector("[data-progress-summary]")||document.querySelector(".progress-summary");return t?new ns({root:t,percentageEl:t.querySelector("[data-progress-percentage]"),barEl:t.querySelector("[data-progress-bar]"),wordsEl:t.querySelector("[data-progress-words]"),paceEl:t.querySelector("[data-progress-pace]")}):null},is=t=>{const e=new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric"});return t.map(a=>{const[s,r,n]=a.split("-").map(d=>Number(d)),o=new Date(s,r-1,n);return{display:e.format(o),raw:o}})},ds=(t,e)=>{const a=e?.length?e.map(d=>d.date):[],s=w(t?.startDate)||(a[0]?w(a[0]):null),r=w(t?.endDate)||(a.length?w(a[a.length-1]):null);if(!s||!r||r<s)return a.filter(Boolean);const n=[];let o=s;for(;o&&o<=r;){const d=k(o);d&&n.push(d),o=Mt(o,1)}return n},ls=(t,e)=>{if(!t.length)return[];if(!e||!e.startDate||!e.endDate)return t.map(()=>0);const a=Number.isFinite(e.goal)&&e.goal>0?e.goal:5e4,s=w(e.startDate),r=w(e.endDate);if(!s||!r)return t.map(()=>0);const n=Math.max(ye(r,s)+1,1);return t.map(({raw:o})=>{const l=(Math.min(Math.max(ye(o,s),0),n-1)+1)/n;return Math.round(a*l)})};class cs{constructor({root:e,canvas:a,placeholder:s}){this.root=e,this.canvas=a,this.placeholder=s,this.chart=null,this.isInitialized=!1}ensureChart(){if(this.chart||!this.canvas||typeof window>"u")return this.chart;if(!window.Chart||typeof window.Chart!="function")return null;const e=this.canvas.getContext("2d");return this.chart=new window.Chart(e,{type:"line",data:{labels:[],datasets:[{label:"Total Words",data:[],borderColor:"#0e7490",backgroundColor:"rgba(14, 116, 144, 0.15)",fill:"origin",tension:.3,borderWidth:3,pointRadius:3},{label:"Pace Line",data:[],borderColor:"#a68968",borderDash:[6,6],tension:0,borderWidth:2,pointRadius:0}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{ticks:{callback:a=>x(a)},beginAtZero:!0}},plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:a=>{const s=a.dataset.label||"",r=x(a.parsed.y);return`${s}: ${r}`}}}}}}),this.chart}setPlaceholder(e,a){this.placeholder&&(this.placeholder.innerHTML=`
      <p class="graph-visual__message">${e}</p>
      <p class="graph-visual__hint">${a}</p>
    `)}update({snapshot:e,project:a}){if(!this.placeholder||!this.root)return;const s=Ot(e?.entries),r=ds(a,s);if(!r.length){this.root.classList.remove("graph-visual--active"),this.setPlaceholder("Start logging words to visualize your progress.","Your daily totals and pace line will appear here once you add entries.");return}const n=is(r),o=ls(n,a),d=new Map(s.map(D=>[D.date,D.cumulative])),l=k(new Date);let c=0,h=0;const m=r.map(D=>l&&D>l?null:(d.has(D)&&(c=d.get(D)),h=c,c)),y=this.ensureChart();if(!y){this.root.classList.remove("graph-visual--active"),this.setPlaceholder(`Latest total: ${x(h)} words`,"Load Chart.js to see the interactive graph.");return}this.root.classList.add("graph-visual--active"),y.data.labels=n.map(D=>D.display),y.data.datasets[0].data=m,y.data.datasets[1].data=o;const B=Number.isFinite(a?.goal)?a.goal:0,T=m.filter(D=>Number.isFinite(D)),V=o.filter(D=>Number.isFinite(D)),ae=Math.max(0,B,...T.length?T:[0],...V.length?V:[0]);y.options?.scales?.y&&(y.options.scales.y.suggestedMax=ae,y.options.scales.y.max=ae);const Ze=this.isInitialized?void 0:"none";y.update(Ze),this.isInitialized=!0}destroy(){this.chart&&(this.chart.destroy(),this.chart=null),this.root&&this.root.classList.remove("graph-visual--active")}}const us=()=>{const t=document.querySelector("[data-graph]");if(!t)return null;const e=t.querySelector("[data-graph-canvas]"),a=t.querySelector("[data-graph-placeholder]");return new cs({root:t,canvas:e,placeholder:a})};class hs{constructor(e={}){const{modal:a,triggers:s=[],onStatToggle:r,onProjectSubmit:n,onFeatureToggle:o,onThemeChange:d,initialTheme:l="classic"}=e;this.modal=a,this.triggers=s,this.onStatToggle=r,this.onProjectSubmit=n,this.onFeatureToggle=o,this.onThemeChange=d,this.dismissElements=Array.from(a?.querySelectorAll("[data-settings-dismiss]")??[]),this.statCheckboxes=Array.from(a?.querySelectorAll("[data-stat-toggle]")??[]),this.featureCheckboxes=Array.from(a?.querySelectorAll("[data-feature-toggle]")??[]),this.themeSelect=a?.querySelector("[data-theme-select]")??null,this.projectForm=a?.querySelector("[data-project-form]")??null,this.projectNameInput=a?.querySelector("[data-project-name]")??null,this.projectStartInput=a?.querySelector("[data-project-start]")??null,this.projectEndInput=a?.querySelector("[data-project-end]")??null,this.projectGoalInput=a?.querySelector("[data-project-goal]")??null,this.projectFeedback=a?.querySelector("[data-project-feedback]")??null,this.projectFeedbackTimeout=null,this.projectSnapshot=null,this.themeValue=l,this.isOpen=!1,this.previouslyFocused=null,this.handleTriggerClick=this.open.bind(this),this.handleDismiss=this.close.bind(this),this.handleKeydown=this.onKeydown.bind(this),this.handleCheckboxChange=this.onCheckboxChange.bind(this),this.handleFeatureChange=this.onFeatureChange.bind(this),this.handleProjectSubmit=this.onProjectFormSubmit.bind(this),this.handleThemeChange=this.onThemeSelectChange.bind(this),this.bindEvents()}bindEvents(){this.triggers.forEach(e=>e.addEventListener("click",this.handleTriggerClick)),this.dismissElements.forEach(e=>e.addEventListener("click",this.handleDismiss)),this.statCheckboxes.forEach(e=>e.addEventListener("change",this.handleCheckboxChange)),this.featureCheckboxes.forEach(e=>e.addEventListener("change",this.handleFeatureChange)),this.themeSelect&&this.themeSelect.addEventListener("change",this.handleThemeChange),this.projectForm&&this.projectForm.addEventListener("submit",this.handleProjectSubmit)}unbindEvents(){this.triggers.forEach(e=>e.removeEventListener("click",this.handleTriggerClick)),this.dismissElements.forEach(e=>e.removeEventListener("click",this.handleDismiss)),this.statCheckboxes.forEach(e=>e.removeEventListener("change",this.handleCheckboxChange)),this.featureCheckboxes.forEach(e=>e.removeEventListener("change",this.handleFeatureChange)),this.themeSelect&&this.themeSelect.removeEventListener("change",this.handleThemeChange),this.projectForm&&this.projectForm.removeEventListener("submit",this.handleProjectSubmit)}open(e){if(e&&e.preventDefault(),!this.modal||this.isOpen)return;this.previouslyFocused=document.activeElement,this.modal.removeAttribute("hidden"),document.addEventListener("keydown",this.handleKeydown),this.isOpen=!0,this.projectSnapshot&&this.populateProjectInputs(this.projectSnapshot),this.themeSelect&&(this.themeSelect.value=this.themeValue);const a=this.modal.querySelector("#settings-modal-title");a&&a.focus()}close(e){e&&e.preventDefault(),!(!this.modal||!this.isOpen)&&(this.modal.setAttribute("hidden",""),document.removeEventListener("keydown",this.handleKeydown),this.isOpen=!1,this.projectFeedback&&(this.projectFeedback.textContent=""),clearTimeout(this.projectFeedbackTimeout),this.previouslyFocused&&typeof this.previouslyFocused.focus=="function"&&this.previouslyFocused.focus(),this.previouslyFocused=null)}onKeydown(e){e.key==="Escape"&&this.close(e)}onCheckboxChange(e){const a=e.target;!a||!a.dataset.statToggle||typeof this.onStatToggle=="function"&&this.onStatToggle(a.dataset.statToggle,a.checked)}onFeatureChange(e){const a=e.target;!a||!a.dataset.featureToggle||typeof this.onFeatureToggle=="function"&&this.onFeatureToggle(a.dataset.featureToggle,a.checked)}onThemeSelectChange(e){const{value:a}=e.target;this.themeValue=a,typeof this.onThemeChange=="function"&&this.onThemeChange(a)}setStatToggle(e,a){const s=this.statCheckboxes.find(r=>r.dataset.statToggle===e);s&&(s.checked=!!a)}setFeatureToggle(e,a){const s=this.featureCheckboxes.find(r=>r.dataset.featureToggle===e);s&&(s.checked=!!a)}setTheme(e){this.themeValue=e,this.themeSelect&&(this.themeSelect.value=e)}setProject(e){this.projectSnapshot={...e||{}},this.isOpen&&this.populateProjectInputs(this.projectSnapshot)}populateProjectInputs(e){e&&(this.projectNameInput&&(this.projectNameInput.value=e.name||""),this.projectStartInput&&(this.projectStartInput.value=e.startDate||""),this.projectEndInput&&(this.projectEndInput.value=e.endDate||""),this.projectGoalInput&&(this.projectGoalInput.value=e.goal||""))}onProjectFormSubmit(e){if(e.preventDefault(),typeof this.onProjectSubmit!="function")return;const a={name:this.projectNameInput?this.projectNameInput.value.trim():"",startDate:this.projectStartInput?this.projectStartInput.value:"",endDate:this.projectEndInput?this.projectEndInput.value:"",goal:this.projectGoalInput?Number(this.projectGoalInput.value):0},s=this.onProjectSubmit(a);this.showProjectFeedback(s)}showProjectFeedback(e){if(!this.projectFeedback)return;const a=e?.message||"Project updated.",s=e&&e.success===!1;this.projectFeedback.textContent=a,this.projectFeedback.classList.toggle("settings-form-feedback--error",!!s),clearTimeout(this.projectFeedbackTimeout),this.projectFeedbackTimeout=setTimeout(()=>{this.projectFeedback&&(this.projectFeedback.textContent="",this.projectFeedback.classList.remove("settings-form-feedback--error"))},3e3)}getSelectedStats(){return this.statCheckboxes.reduce((e,a)=>(a.dataset.statToggle&&(e[a.dataset.statToggle]=a.checked),e),{})}getSelectedFeatures(){return this.featureCheckboxes.reduce((e,a)=>(a.dataset.featureToggle&&(e[a.dataset.featureToggle]=a.checked),e),{})}destroy(){this.unbindEvents(),document.removeEventListener("keydown",this.handleKeydown),this.statCheckboxes=[],this.featureCheckboxes=[],this.themeSelect=null,this.triggers=[],this.dismissElements=[],clearTimeout(this.projectFeedbackTimeout)}}const ms=({onStatToggle:t,onProjectSubmit:e,onFeatureToggle:a,onThemeChange:s,initialTheme:r}={})=>{const n=document.querySelector("[data-settings-modal]");if(!n)return null;const o=Array.from(document.querySelectorAll("[data-settings-trigger]"));return new hs({modal:n,triggers:o,onStatToggle:t,onProjectSubmit:e,onFeatureToggle:a,onThemeChange:s,initialTheme:r})},ps="data/books.json";let Ee=null,et=null;const gs=()=>[{title:"The Metamorphosis",author:"Franz Kafka",words:22e3},{title:"The Old Man and the Sea",author:"Ernest Hemingway",words:27e3},{title:"A Christmas Carol",author:"Charles Dickens",words:29e3},{title:"Of Mice and Men",author:"John Steinbeck",words:3e4},{title:"Animal Farm",author:"George Orwell",words:3e4},{title:"The Hitchhiker's Guide to the Galaxy",author:"Douglas Adams",words:46e3},{title:"Fahrenheit 451",author:"Ray Bradbury",words:46e3},{title:"The Great Gatsby",author:"F. Scott Fitzgerald",words:47e3},{title:"Lord of the Flies",author:"William Golding",words:59e3},{title:"The Catcher in the Rye",author:"J. D. Salinger",words:73e3},{title:"Harry Potter and the Philosopher's Stone",author:"J. K. Rowling",words:77e3},{title:"1984",author:"George Orwell",words:88e3},{title:"The Hobbit",author:"J. R. R. Tolkien",words:95e3},{title:"The Fellowship of the Ring",author:"J. R. R. Tolkien",words:187e3}],fs=async()=>Ee||et||(et=fetch(ps).then(async t=>{if(!t.ok)throw new Error(`Failed to load books.json: ${t.status}`);const e=await t.json();if(!Array.isArray(e))throw new Error("Invalid book data");return Ee=e.map(a=>({title:a.title,author:a.author,words:Number(a.words)})).filter(a=>a.title&&Number.isFinite(a.words)).sort((a,s)=>a.words-s.words),Ee}).catch(t=>(console.warn("Using fallback book data",t),Ee=gs(),Ee)),et),ys=(t,e)=>{if(!Array.isArray(t)||!Number.isFinite(e))return[];const a=t.filter(s=>e>=s.words);return a.length<=3?a:a.slice(-3)},ws=(t,e)=>!Array.isArray(t)||!Number.isFinite(e)?null:t.find(a=>e<a.words)||null;class bs{constructor({root:e,listEl:a,nextTargetEl:s,emptyStateEl:r}={}){this.root=e,this.listEl=a,this.nextTargetEl=s,this.emptyStateEl=r,this.books=[]}setBooks(e){this.books=Array.isArray(e)?e:[]}update({totalWords:e}){if(!this.root)return;if(!this.books.length||!Number.isFinite(e)){this.root.setAttribute("hidden","");return}const a=ys(this.books,e),s=ws(this.books,e);if(!a.length){this.root.removeAttribute("hidden"),this.listEl&&(this.listEl.innerHTML=""),this.nextTargetEl&&this.nextTargetEl.setAttribute("hidden",""),this.emptyStateEl&&this.emptyStateEl.removeAttribute("hidden");return}this.root.removeAttribute("hidden"),this.listEl&&(this.listEl.innerHTML="",a.forEach(r=>{const n=document.createElement("li");n.className="book-comparison__item",n.innerHTML=`
          <div class="book-comparison__title">${r.title}</div>
          <div class="book-comparison__meta">${r.author||"Unknown"} · ${r.words.toLocaleString()} words</div>
        `,this.listEl.appendChild(n)})),this.nextTargetEl&&(s?(this.nextTargetEl.removeAttribute("hidden"),this.nextTargetEl.innerHTML=`
          Keep going! Next up: <strong>${s.title}</strong> at ${s.words.toLocaleString()} words.
        `):this.nextTargetEl.setAttribute("hidden","")),this.emptyStateEl&&this.emptyStateEl.setAttribute("hidden","")}destroy(){this.root&&this.root.setAttribute("hidden",""),this.listEl&&(this.listEl.innerHTML="")}}const ks=()=>{const t=document.querySelector("[data-book-comparisons]");if(!t)return null;const e=t.querySelector("[data-book-comparisons-list]"),a=t.querySelector("[data-book-comparisons-next]"),s=t.querySelector("[data-book-comparisons-empty]");return new bs({root:t,listEl:e,nextTargetEl:a,emptyStateEl:s})},Ss={VITE_SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yeGlsdWVnbW1yY2d1a3F1YmVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjY5NjEsImV4cCI6MjA3NzM0Mjk2MX0.mTwN8SSOTcw7m1qLklNL7w2R28LJEmBFp3nKmyMYIv8",VITE_SUPABASE_URL:"https://nrxiluegmmrcgukqubek.supabase.co"},pa=Ss||{},Tt=pa.VITE_SUPABASE_URL||window.__SUPABASE_URL__||"",Dt=pa.VITE_SUPABASE_ANON_KEY||window.__SUPABASE_ANON_KEY__||"";(!Tt||!Dt)&&console.warn("Supabase credentials are missing. Set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY in your environment.");const u=Tt&&Dt?Ia(Tt,Dt,{auth:{persistSession:!0,detectSessionInUrl:!0}}):null,At="1.0.0",tt=t=>JSON.parse(JSON.stringify(t)),vs=({project:t,entries:e,preferences:a,rewards:s})=>({metadata:{version:At,exportedAt:new Date().toISOString()},project:tt(t||{}),entries:tt(e||[]),preferences:tt(a||{}),rewards:tt(s||{})}),Es=(t,e)=>{const a=new Blob([`${JSON.stringify(t,null,2)}
`],{type:"application/json"}),s=URL.createObjectURL(a),r=document.createElement("a");r.href=s,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s)},js=t=>new Promise((e,a)=>{const s=new FileReader;s.addEventListener("load",()=>{try{const r=JSON.parse(s.result);e(r)}catch(r){a(r)}}),s.addEventListener("error",()=>a(s.error)),s.readAsText(t)}),Ts=t=>{const e=[];return!t||typeof t!="object"?(e.push("Backup file is not valid JSON."),{valid:!1,errors:e}):(!t.metadata||typeof t.metadata!="object"?e.push("Backup missing metadata."):t.metadata.version||e.push("Backup missing version information."),(!t.project||typeof t.project!="object")&&e.push("Backup missing project data."),Array.isArray(t.entries)||e.push("Backup missing entries array."),(!t.preferences||typeof t.preferences!="object")&&e.push("Backup missing preferences."),{valid:e.length===0,errors:e})},Ds=[{id:"kitten-001",pack:"kitten",image:"rewards/kitten/adrien-hByCzZ6wSGk-unsplash.jpg",label:"Adrien HByCzZ6wSGk Unsplash",message:"Great job staying on track today!"},{id:"kitten-002",pack:"kitten",image:"rewards/kitten/alexey-demidov-TxuKaJBjUSA-unsplash.jpg",label:"Alexey Demidov TxuKaJBjUSA Unsplash",message:"Great job staying on track today!"},{id:"kitten-003",pack:"kitten",image:"rewards/kitten/amirreza-tavassoli-3g5ZR74hJeA-unsplash.jpg",label:"Amirreza Tavassoli 3g5ZR74hJeA Unsplash",message:"Great job staying on track today!"},{id:"kitten-004",pack:"kitten",image:"rewards/kitten/anton-atanasov-U64zQ--i7SE-unsplash.jpg",label:"Anton Atanasov U64zQ  I7SE Unsplash",message:"Great job staying on track today!"},{id:"kitten-005",pack:"kitten",image:"rewards/kitten/ashray-bhatt-kRwBJu2T0pA-unsplash.jpg",label:"Ashray Bhatt KRwBJu2T0pA Unsplash",message:"Great job staying on track today!"},{id:"kitten-006",pack:"kitten",image:"rewards/kitten/atharva-whaval-v04I1xrOY_k-unsplash.jpg",label:"Atharva Whaval V04I1xrOY K Unsplash",message:"Great job staying on track today!"},{id:"kitten-007",pack:"kitten",image:"rewards/kitten/bui-RV3lYRbefg4-unsplash.jpg",label:"Bui RV3lYRbefg4 Unsplash",message:"Great job staying on track today!"},{id:"kitten-008",pack:"kitten",image:"rewards/kitten/connor-tollison-U-ZtSpzZ_SA-unsplash.jpg",label:"Connor Tollison U ZtSpzZ SA Unsplash",message:"Great job staying on track today!"},{id:"kitten-009",pack:"kitten",image:"rewards/kitten/diana-rafira-0OTOmSTsLjc-unsplash.jpg",label:"Diana Rafira 0OTOmSTsLjc Unsplash",message:"Great job staying on track today!"},{id:"kitten-010",pack:"kitten",image:"rewards/kitten/dmitriy-shvarev-OKNbqkvYtnA-unsplash.jpg",label:"Dmitriy Shvarev OKNbqkvYtnA Unsplash",message:"Great job staying on track today!"},{id:"kitten-011",pack:"kitten",image:"rewards/kitten/eduard-delputte-SzbhSlVFIbM-unsplash.jpg",label:"Eduard Delputte SzbhSlVFIbM Unsplash",message:"Great job staying on track today!"},{id:"kitten-012",pack:"kitten",image:"rewards/kitten/emmalee-couturier-7zbkim32dSI-unsplash.jpg",label:"Emmalee Couturier 7zbkim32dSI Unsplash",message:"Great job staying on track today!"},{id:"kitten-013",pack:"kitten",image:"rewards/kitten/enzo-kin-gAAsHpj38bw-unsplash.jpg",label:"Enzo Kin GAAsHpj38bw Unsplash",message:"Great job staying on track today!"},{id:"kitten-014",pack:"kitten",image:"rewards/kitten/gary-bendig-6GMq7AGxNbE-unsplash.jpg",label:"Gary Bendig 6GMq7AGxNbE Unsplash",message:"Great job staying on track today!"},{id:"kitten-015",pack:"kitten",image:"rewards/kitten/haci-elmas-mNGr-XhFfXw-unsplash.jpg",label:"Haci Elmas MNGr XhFfXw Unsplash",message:"Great job staying on track today!"},{id:"kitten-016",pack:"kitten",image:"rewards/kitten/iam_os-pMidin9x1nE-unsplash.jpg",label:"Iam Os PMidin9x1nE Unsplash",message:"Great job staying on track today!"},{id:"kitten-017",pack:"kitten",image:"rewards/kitten/jayden-sim-vm9qrcfVzPM-unsplash.jpg",label:"Jayden Sim Vm9qrcfVzPM Unsplash",message:"Great job staying on track today!"},{id:"kitten-018",pack:"kitten",image:"rewards/kitten/john-xiao-qi-y5UOG2Hs-unsplash.jpg",label:"John Xiao Qi Y5UOG2Hs Unsplash",message:"Great job staying on track today!"},{id:"kitten-019",pack:"kitten",image:"rewards/kitten/kaushik-murali-mOO5Ht1EZG8-unsplash.jpg",label:"Kaushik Murali MOO5Ht1EZG8 Unsplash",message:"Great job staying on track today!"},{id:"kitten-020",pack:"kitten",image:"rewards/kitten/kerin-gedge-JDzoTGfoogA-unsplash.jpg",label:"Kerin Gedge JDzoTGfoogA Unsplash",message:"Great job staying on track today!"},{id:"kitten-021",pack:"kitten",image:"rewards/kitten/km-enger-design-I8KUL1m9P_0-unsplash.jpg",label:"Km Enger Design I8KUL1m9P 0 Unsplash",message:"Great job staying on track today!"},{id:"kitten-022",pack:"kitten",image:"rewards/kitten/le-thanh-son-aATmDHlAuPc-unsplash.jpg",label:"Le Thanh Son AATmDHlAuPc Unsplash",message:"Great job staying on track today!"},{id:"kitten-023",pack:"kitten",image:"rewards/kitten/maria-garza-eId5uAVj2uc-unsplash.jpg",label:"Maria Garza EId5uAVj2uc Unsplash",message:"Great job staying on track today!"},{id:"kitten-024",pack:"kitten",image:"rewards/kitten/marie-michele-bouchard-9MXrPaCvDps-unsplash.jpg",label:"Marie Michele Bouchard 9MXrPaCvDps Unsplash",message:"Great job staying on track today!"},{id:"kitten-025",pack:"kitten",image:"rewards/kitten/mas-irfan-_6Yynu94_zU-unsplash.jpg",label:"Mas Irfan  6Yynu94 ZU Unsplash",message:"Great job staying on track today!"},{id:"kitten-026",pack:"kitten",image:"rewards/kitten/mauricio-farias-A7vJNaZx80M-unsplash.jpg",label:"Mauricio Farias A7vJNaZx80M Unsplash",message:"Great job staying on track today!"},{id:"kitten-027",pack:"kitten",image:"rewards/kitten/mike-stimpson-re6oXuTdMHQ-unsplash.jpg",label:"Mike Stimpson Re6oXuTdMHQ Unsplash",message:"Great job staying on track today!"},{id:"kitten-028",pack:"kitten",image:"rewards/kitten/muhamad-fazli-yaacob-py8luHq3Jh4-unsplash.jpg",label:"Muhamad Fazli Yaacob Py8luHq3Jh4 Unsplash",message:"Great job staying on track today!"},{id:"kitten-029",pack:"kitten",image:"rewards/kitten/muhammad-shah-zeb-LFCXaxok7oo-unsplash.jpg",label:"Muhammad Shah Zeb LFCXaxok7oo Unsplash",message:"Great job staying on track today!"},{id:"kitten-030",pack:"kitten",image:"rewards/kitten/mustafa-akin-Dw7DVi_DrcM-unsplash.jpg",label:"Mustafa Akin Dw7DVi DrcM Unsplash",message:"Great job staying on track today!"},{id:"kitten-031",pack:"kitten",image:"rewards/kitten/nasa-hI5dX2ObAs-unsplash-scaled.jpg",label:"Nasa HI5dX2ObAs Unsplash Scaled",message:"Great job staying on track today!"},{id:"kitten-032",pack:"kitten",image:"rewards/kitten/nikhil-k-4Ic1lgpA__Q-unsplash.jpg",label:"Nikhil K 4Ic1lgpA  Q Unsplash",message:"Great job staying on track today!"},{id:"kitten-033",pack:"kitten",image:"rewards/kitten/nikhil-k-lnvFoqWmwnQ-unsplash.jpg",label:"Nikhil K LnvFoqWmwnQ Unsplash",message:"Great job staying on track today!"},{id:"kitten-034",pack:"kitten",image:"rewards/kitten/nygi-AF6ZJGsSlHg-unsplash.jpg",label:"Nygi AF6ZJGsSlHg Unsplash",message:"Great job staying on track today!"},{id:"kitten-035",pack:"kitten",image:"rewards/kitten/nygi-E6J_U2HG89w-unsplash.jpg",label:"Nygi E6J U2HG89w Unsplash",message:"Great job staying on track today!"},{id:"kitten-036",pack:"kitten",image:"rewards/kitten/olga-bi-87kmTmHRiVg-unsplash.jpg",label:"Olga Bi 87kmTmHRiVg Unsplash",message:"Great job staying on track today!"},{id:"kitten-037",pack:"kitten",image:"rewards/kitten/pedro-forester-da-silva-_DgP1NUkJ_4-unsplash.jpg",label:"Pedro Forester Da Silva  DgP1NUkJ 4 Unsplash",message:"Great job staying on track today!"},{id:"kitten-038",pack:"kitten",image:"rewards/kitten/philippine-fitamant-UoNO74xD-JA-unsplash.jpg",label:"Philippine Fitamant UoNO74xD JA Unsplash",message:"Great job staying on track today!"},{id:"kitten-039",pack:"kitten",image:"rewards/kitten/reza-yaghoobian-3myCgRaOn54-unsplash.jpg",label:"Reza Yaghoobian 3myCgRaOn54 Unsplash",message:"Great job staying on track today!"},{id:"kitten-040",pack:"kitten",image:"rewards/kitten/rocky-yGLkEpcDcIM-unsplash.jpg",label:"Rocky YGLkEpcDcIM Unsplash",message:"Great job staying on track today!"},{id:"kitten-041",pack:"kitten",image:"rewards/kitten/shikhar-bhatnagar-BQolqSUXExk-unsplash.jpg",label:"Shikhar Bhatnagar BQolqSUXExk Unsplash",message:"Great job staying on track today!"},{id:"kitten-042",pack:"kitten",image:"rewards/kitten/sierra-nicole-narvaeth-6NWphpA-QMg-unsplash.jpg",label:"Sierra Nicole Narvaeth 6NWphpA QMg Unsplash",message:"Great job staying on track today!"},{id:"kitten-043",pack:"kitten",image:"rewards/kitten/tahamie-farooqui-Vznb4lUQDuc-unsplash.jpg",label:"Tahamie Farooqui Vznb4lUQDuc Unsplash",message:"Great job staying on track today!"},{id:"kitten-044",pack:"kitten",image:"rewards/kitten/the-lucky-neko-27Vy4cRzbd0-unsplash.jpg",label:"The Lucky Neko 27Vy4cRzbd0 Unsplash",message:"Great job staying on track today!"},{id:"kitten-045",pack:"kitten",image:"rewards/kitten/the-lucky-neko-2R0JNId-rwg-unsplash.jpg",label:"The Lucky Neko 2R0JNId Rwg Unsplash",message:"Great job staying on track today!"},{id:"kitten-046",pack:"kitten",image:"rewards/kitten/the-lucky-neko-9NhkTXal1QI-unsplash.jpg",label:"The Lucky Neko 9NhkTXal1QI Unsplash",message:"Great job staying on track today!"},{id:"kitten-047",pack:"kitten",image:"rewards/kitten/the-lucky-neko-CM7a-XBD4AU-unsplash.jpg",label:"The Lucky Neko CM7a XBD4AU Unsplash",message:"Great job staying on track today!"},{id:"kitten-048",pack:"kitten",image:"rewards/kitten/the-lucky-neko-DuldOJpLBMY-unsplash.jpg",label:"The Lucky Neko DuldOJpLBMY Unsplash",message:"Great job staying on track today!"},{id:"kitten-049",pack:"kitten",image:"rewards/kitten/the-lucky-neko-MWb-A8UandA-unsplash.jpg",label:"The Lucky Neko MWb A8UandA Unsplash",message:"Great job staying on track today!"},{id:"kitten-050",pack:"kitten",image:"rewards/kitten/the-lucky-neko-Xs8VJFAQDuw-unsplash.jpg",label:"The Lucky Neko Xs8VJFAQDuw Unsplash",message:"Great job staying on track today!"},{id:"kitten-051",pack:"kitten",image:"rewards/kitten/the-lucky-neko-Zp-OCg7j2Fg-unsplash.jpg",label:"The Lucky Neko Zp OCg7j2Fg Unsplash",message:"Great job staying on track today!"},{id:"kitten-052",pack:"kitten",image:"rewards/kitten/the-lucky-neko-a1N-ZkLxXKU-unsplash.jpg",label:"The Lucky Neko A1N ZkLxXKU Unsplash",message:"Great job staying on track today!"},{id:"kitten-053",pack:"kitten",image:"rewards/kitten/the-lucky-neko-bSuYJifHHKQ-unsplash.jpg",label:"The Lucky Neko BSuYJifHHKQ Unsplash",message:"Great job staying on track today!"},{id:"kitten-054",pack:"kitten",image:"rewards/kitten/the-lucky-neko-rplhB9mYF48-unsplash.jpg",label:"The Lucky Neko RplhB9mYF48 Unsplash",message:"Great job staying on track today!"},{id:"kitten-055",pack:"kitten",image:"rewards/kitten/the-lucky-neko-tUTlUel_Nvs-unsplash.jpg",label:"The Lucky Neko TUTlUel Nvs Unsplash",message:"Great job staying on track today!"},{id:"kitten-056",pack:"kitten",image:"rewards/kitten/thomas-de-fretes-QRsDpGPV7qk-unsplash.jpg",label:"Thomas De Fretes QRsDpGPV7qk Unsplash",message:"Great job staying on track today!"},{id:"kitten-057",pack:"kitten",image:"rewards/kitten/timofey-mikheev-7-H5kcfWdZk-unsplash.jpg",label:"Timofey Mikheev 7 H5kcfWdZk Unsplash",message:"Great job staying on track today!"},{id:"kitten-058",pack:"kitten",image:"rewards/kitten/tugce-besel-Na_0NdUGFng-unsplash.jpg",label:"Tugce Besel Na 0NdUGFng Unsplash",message:"Great job staying on track today!"},{id:"kitten-059",pack:"kitten",image:"rewards/kitten/vladimir-butucea-jG2mRkvKi6U-unsplash.jpg",label:"Vladimir Butucea JG2mRkvKi6U Unsplash",message:"Great job staying on track today!"},{id:"kitten-060",pack:"kitten",image:"rewards/kitten/xiao-suen-r0iAODhx8NU-unsplash.jpg",label:"Xiao Suen R0iAODhx8NU Unsplash",message:"Great job staying on track today!"},{id:"kitten-061",pack:"kitten",image:"rewards/kitten/zetong-li-yP9RVhXbC60-unsplash.jpg",label:"Zetong Li YP9RVhXbC60 Unsplash",message:"Great job staying on track today!"}],ga=()=>[...Ds],fa="wordtracker:v2:rewards",Ut=ga(),Pe=()=>{if(typeof window>"u"||!window.localStorage)return{};try{const t=window.localStorage.getItem(fa);if(!t)return{};const e=JSON.parse(t);return typeof e=="object"&&e!==null?e:{}}catch(t){return console.warn("Failed to read rewards store",t),{}}},ht=t=>{if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(fa,JSON.stringify(t||{}))}catch(e){console.warn("Failed to persist rewards store",e)}},Ft=t=>k(t),ya=t=>t&&Ut.find(e=>e.id===t)||null,Ke=t=>{if(!t||typeof t!="object")return null;const e=ya(t.id);return e?{id:e.id,pack:e.pack,image:e.image,label:e.label,message:t.message||e.message,unlockedAt:t.unlockedAt||new Date().toISOString()}:{...t,unlockedAt:t.unlockedAt||new Date().toISOString()}},As=(t={})=>{const e=new Map;Object.values(t).forEach(r=>{if(r&&r.id){const n=e.get(r.id)||0;e.set(r.id,n+1)}});let a=null,s=1/0;return Ut.forEach(r=>{const n=e.get(r.id)||0;n<s&&(s=n,a=r)}),a||Ut[0]},wa=(t,e,a)=>{const s=Pe(),r=s[t]||{};return r[e]=a,s[t]=r,ht(s),a},Us=()=>Pe(),xt=t=>{ht(typeof t=="object"&&t!==null?t:{})},$=t=>{if(!t)return[];const a=Pe()[t]||{};return Object.entries(a).map(([s,r])=>{const n=Ke(r);return n?{...n,date:s}:null}).filter(Boolean).sort((s,r)=>s.date<r.date?1:-1)},Fs=({projectId:t,metrics:e,today:a=new Date})=>{if(!t)return{reward:null,rewards:[],unlockedToday:!1,date:null};const r=Pe()[t]||{},n=Ft(a),o=r[n]?Ke(r[n]):null;if(!(e?.highlightToday||!1))return{reward:o,rewards:$(t),unlockedToday:!1,date:n};if(o)return{reward:o,rewards:$(t),unlockedToday:!1,date:n};const l=As(r),c=Ke({id:l.id,message:l.message,unlockedAt:new Date().toISOString()});return wa(t,n,c),{reward:c,rewards:$(t),unlockedToday:!0,date:n}},Cs=({projectId:t,dateKey:e,rewardId:a,message:s,unlockedAt:r})=>{if(!t||!e||!a)throw new Error("Project, date, and reward id are required.");const n=ya(a);if(!n)throw new Error("Unknown reward id.");const o=Ke({id:n.id,message:s||n.message,unlockedAt:r||new Date().toISOString()});return wa(t,e,o),o},ba=(t,e)=>{if(!t||!e)return;const a=Pe();a[t]&&(delete a[t][e],Object.keys(a[t]).length||delete a[t],ht(a))},ka=(t,e=[])=>{if(!t)return[];const a=Pe(),s={};return(Array.isArray(e)?e:[]).forEach(r=>{if(!r||typeof r!="object")return;const n=typeof r.date=="string"?r.date:r.date?Ft(r.date):Ft(r.reward_date);if(!n)return;const o=Ke({id:r.id||r.rewardId||r.reward_id,message:r.message??r.rewardMessage??r.reward_message,unlockedAt:r.unlockedAt||r.unlocked_at});o&&(s[n]=o)}),Object.keys(s).length?a[t]=s:delete a[t],ht(a),$(t)},Ns=new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric",year:"numeric"});class Ps{constructor({modal:e,grid:a,emptyState:s,dismissSelectors:r=[],triggers:n=[]}={}){this.modal=e,this.grid=a,this.emptyState=s,this.rewards=[],this.triggers=new Set,this.dismissElements=[],this.previouslyFocused=null,this.handleTrigger=this.open.bind(this),this.handleDismiss=this.close.bind(this),this.handleKeydown=this.onKeydown.bind(this),e&&r.length&&r.forEach(o=>{e.querySelectorAll(o).forEach(d=>this.registerDismissElement(d))}),n.forEach(o=>this.registerTrigger(o))}registerTrigger(e){!e||this.triggers.has(e)||(this.triggers.add(e),e.addEventListener("click",this.handleTrigger))}unregisterTrigger(e){!e||!this.triggers.has(e)||(e.removeEventListener("click",this.handleTrigger),this.triggers.delete(e))}registerDismissElement(e){e&&(e.addEventListener("click",this.handleDismiss),this.dismissElements.push(e))}open(e){if(e&&e.preventDefault(),!this.modal||!this.modal.hasAttribute("hidden"))return;this.previouslyFocused=document.activeElement,this.modal.removeAttribute("hidden"),document.addEventListener("keydown",this.handleKeydown);const a=this.modal.querySelector("#reward-gallery-title");a&&a.focus()}close(e){e&&e.preventDefault(),!(!this.modal||this.modal.hasAttribute("hidden"))&&(this.modal.setAttribute("hidden",""),document.removeEventListener("keydown",this.handleKeydown),this.previouslyFocused&&typeof this.previouslyFocused.focus=="function"&&this.previouslyFocused.focus(),this.previouslyFocused=null)}onKeydown(e){e.key==="Escape"&&this.close(e)}setRewards(e){this.rewards=Array.isArray(e)?e:[],this.render()}render(){if(!(!this.grid||!this.emptyState)){if(this.grid.innerHTML="",!this.rewards.length){this.emptyState.removeAttribute("hidden");return}this.emptyState.setAttribute("hidden",""),this.rewards.forEach(e=>{const a=document.createElement("article");a.className="gallery-card",a.dataset.rewardId=e.id||"",a.dataset.rewardImage=e.image||"",a.dataset.rewardLabel=e.label||e.name||"Reward",a.dataset.rewardMessage=e.message||"",a.dataset.rewardDate=e.date||"";const s=document.createElement("div");if(s.className="gallery-card__thumb",e.image){const r=document.createElement("img");r.src=e.image,r.alt=e.label||e.name||"Daily reward",s.appendChild(r)}else s.classList.add("gallery-card__thumb--empty"),s.textContent=e.emoji||"✨";if(a.appendChild(s),e.unlockedAt||e.date){const r=document.createElement("p");r.className="gallery-card__date";const n=e.unlockedAt||e.date,o=new Date(n);r.textContent=Ns.format(o),a.appendChild(r)}if(e.message){const r=document.createElement("p");r.className="gallery-card__message",r.textContent=e.message,a.appendChild(r)}this.grid.appendChild(a)})}}refreshTriggers(){this.triggers.forEach(e=>{document.contains(e)||this.unregisterTrigger(e)})}destroy(){this.triggers.forEach(e=>e.removeEventListener("click",this.handleTrigger)),this.dismissElements.forEach(e=>e.removeEventListener("click",this.handleDismiss)),document.removeEventListener("keydown",this.handleKeydown),this.triggers.clear(),this.dismissElements=[]}}const Ls=()=>{const t=document.querySelector("[data-reward-gallery-modal]");if(!t)return null;const e=t.querySelector("[data-gallery-grid]"),a=t.querySelector("[data-gallery-empty]"),s=["[data-gallery-dismiss]"];return new Ps({modal:t,grid:e,emptyState:a,dismissSelectors:s})},U={newLayoutRoot:"#new-layout",projectName:"[data-project-name]",dayProgress:"[data-day-progress]",settingsTrigger:"[data-settings-trigger]",wordEntry:"[data-word-entry]",wordEntryLegacy:"[data-word-entry-legacy]",rewardSection:"[data-reward-section]",rewardCard:"[data-reward-card]",rewardImage:"[data-reward-image]",rewardMessage:"[data-reward-message]",rewardEmpty:"[data-reward-empty]",rewardGalleryTrigger:"[data-reward-gallery-trigger]"};let i=Ya();const Fe=document.querySelector('[data-action="dev-edit"]');let We=null;const ie=()=>{const t=document.querySelector(U.projectName);t&&(t.textContent=i.name||"My Novel");const e=document.querySelector(U.dayProgress);e&&!e.textContent.trim()&&(e.textContent="Day 1 of 30")},_s={setProjectName(t){const e=document.querySelector(U.projectName);e&&(e.textContent=t)},setDayProgress(t){const e=document.querySelector(U.dayProgress);e&&(e.textContent=t)},getSettingsTrigger(){return document.querySelector(U.settingsTrigger)}};let S=null,A=null,Qt=!1,oe=null,H=null,p=null,Ce=null,Q=[],z=null,Ct=[],M=null;const ne={editingDate:null};let ze=null,ea=!0;const de="reward_history";let le=!0;const ee=ct(),Nt=ga(),qt=new Map(Nt.map(t=>[t.id,t])),Sa=new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric",year:"numeric"}),ce={averageWords:!0,wordsRemaining:!0,bestDay:!0,currentStreak:!0,projectedFinish:!0,percentage:!0},ue={rewardsSystem:!0,bookComparisons:!0,devFeatures:!1},j={...ce};Object.keys(j).forEach(t=>{ee.optionalStats&&Object.prototype.hasOwnProperty.call(ee.optionalStats,t)&&(j[t]=ee.optionalStats[t]!==!1)});const F={...ue};Object.keys(F).forEach(t=>{ee.features&&Object.prototype.hasOwnProperty.call(ee.features,t)&&(F[t]=ee.features[t]!==!1)});const Gt=Object.freeze(["classic","emerald","midnight","sunset"]);let J=Gt.includes(ee.theme)?ee.theme:"classic";Gt.includes(ee.theme)||ua(J);const va=t=>{const e=document.body;if(!e)return;const a=`theme-${t}`;Array.from(e.classList).forEach(s=>{s.startsWith("theme-")&&e.classList.remove(s)}),e.classList.add(a)};va(J);const ve=(t,{persistLocal:e=!0,persistRemote:a=!0}={})=>{const s=Gt.includes(t)?t:"classic";J===s&&document.body?.classList.contains(`theme-${s}`)||(J=s,va(s),e&&ua(s),p&&p.setTheme(s),f&&a&&ge())},we={addWords:g.addWords.bind(g),setTotal:g.setTotal.bind(g),undoLastEntry:g.undoLastEntry.bind(g),replaceState:g.replaceState.bind(g),reset:g.reset.bind(g)};let f=null;const qe=document.getElementById("app"),Ae=document.querySelector("[data-auth-overlay]"),Pt=Ae?.querySelector("[data-auth-form]")||null,Ge=Ae?.querySelector("[data-auth-email]")||null,G=Ae?.querySelector("[data-auth-feedback]")||null,at=Pt?.querySelector('button[type="submit"]')||null,vt=document.querySelector("[data-auth-display]"),st=document.querySelector("[data-auth-user]"),Is=document.querySelector("[data-auth-logout]"),fe=document.querySelector('[data-action="export"]'),ta=document.querySelector('[data-action="import"]'),aa=document.querySelector('[data-action="reset"]'),Et=document.querySelector("[data-import-input]"),I=document.querySelector(U.rewardSection),W=document.querySelector(U.rewardCard),R=document.querySelector(U.rewardImage),sa=document.querySelector(U.rewardMessage),he=document.querySelector(U.rewardEmpty),nt=document.querySelector(U.rewardGalleryTrigger),Lt=document.querySelector("[data-reward-gallery-modal]"),O=document.querySelector("[data-reward-image-trigger]"),Je=document.querySelector('[data-action="manage-rewards"]'),C=document.querySelector("[data-rewards-admin-modal]"),_t=C?.querySelector("[data-rewards-admin-form]")||null,Ne=C?.querySelector("[data-admin-reward-date]")||null,E=C?.querySelector("[data-admin-reward-select]")||null,Y=C?.querySelector("[data-admin-reward-message]")||null,ra=C?.querySelector("[data-admin-reward-default]")||null,$e=C?.querySelector("[data-rewards-admin-list]")||null,rt=C?.querySelector("[data-rewards-admin-empty]")||null,Rs=Array.from(C?.querySelectorAll("[data-rewards-admin-dismiss]")||[]),me=document.querySelector("[data-image-modal]"),jt=me?.querySelector("[data-image-modal-title]")||null,Ue=me?.querySelector("[data-image-modal-picture]")||null,na=me?.querySelector("[data-image-modal-caption]")||null,Ms=Array.from(me?.querySelectorAll("[data-image-modal-dismiss]")||[]);Fe&&(Fe.hidden=!0);const je=t=>j[t]!==!1,Le=(t,e,a={})=>{const{syncLocal:s=!0,syncRemote:r=!0}=a;Object.prototype.hasOwnProperty.call(j,t)&&(j[t]=!!e,s&&Va(t,e),f&&r&&ge())},pe=t=>F[t]!==!1,_e=(t,e,a={})=>{const{syncLocal:s=!0,syncRemote:r=!0}=a;Object.prototype.hasOwnProperty.call(F,t)&&(F[t]=!!e,s&&Ha(t,e),t==="bookComparisons"&&(e&&q("bookComparisons")?Ca():Jt()),t==="rewardsSystem"&&(e&&q("rewardsSystem")?Na():Pa()),t==="devFeatures"&&(Fa(e),!e&&We&&We.close()),N(),f&&r&&ge())},Os=()=>({setProgress(t){oe&&oe.setProgress(t)}}),xs=()=>({update(t){H&&H.update(t)}}),qs=()=>({open(){p&&p.open()},setStatEnabled(t,e){Le(t,e),p&&p.setStatToggle(t,e),N()},getSelections(){return{...j}},setFeatureEnabled(t,e){_e(t,e),p&&p.setFeatureToggle(t,e)},getFeatureSelections(){return{...F}},setTheme(t){ve(t)},getTheme(){return J}}),Gs=()=>({setStat(t,e){S&&S.setStat(t,e)},reset(){S&&S.resetStats()},getRoot(){return S?S.getRoot():null},setVisibility(t){S&&Object.entries(t||{}).forEach(([e,a])=>{S.setStat(e,{hidden:!a})})}}),Bs=()=>({setStatus(t){A&&A.updateStatus(t)},focusInput(){A&&A.focusInput()},setTotalWords(t){A&&A.setTotalWords(t)},getState(){return A?A.getState():null},setMode(t,e){A&&A.setMode(t,e)},getMode(){return A?A.getMode():"add"}}),Ws=(t={})=>{const e=K(),a=s=>{if(!s)return e.startDate;const r=Se(s);return r?k(r):e.startDate};return{id:typeof t.id=="string"&&t.id?t.id:void 0,name:typeof t.name=="string"&&t.name.trim()?t.name.trim():e.name,goal:Number.isFinite(Number(t.goal))&&Number(t.goal)>0?Math.round(Number(t.goal)):e.goal,startDate:a(t.startDate||t.start_date||e.startDate),endDate:a(t.endDate||t.end_date||e.endDate)}},zs=(t=[])=>{if(!Array.isArray(t)||!t.length)return[];const e=t.map((r,n)=>{const o=(()=>{const l=r?.timestamp??r?.date;if(typeof l=="number")return Number.isFinite(l)?l:null;if(typeof l=="string"){const c=Date.parse(l);return Number.isFinite(c)?c:null}return null})();if(!Number.isFinite(o))return null;const d=Number(r?.delta??r?.value??0);return Number.isFinite(d)?{timestamp:o,delta:d,id:typeof r?.id=="string"&&r.id?r.id:`import-${o}-${n}`}:null}).filter(Boolean).sort((r,n)=>r.timestamp-n.timestamp);let a=0;return e.map(r=>{const n=Math.max(a,0),o=r.delta,d=n+o,l=Math.max(d,0);return a=l,{id:r.id,mode:"add",delta:o,previousTotal:n,newTotal:l,timestamp:r.timestamp}})},$s=(t={})=>{const e=typeof t.optionalStats=="object"&&t.optionalStats!==null?t.optionalStats:{},a=typeof t.features=="object"&&t.features!==null?t.features:{},s=typeof t.theme=="string"?t.theme:"classic";return{optionalStats:e,features:a,theme:s}},Ks=()=>{const e=[...g.getSnapshot().entries||[]].map(n=>({id:n.id,mode:n.mode,delta:n.delta,previousTotal:n.previousTotal,newTotal:n.newTotal,timestamp:n.timestamp})).sort((n,o)=>n.timestamp-o.timestamp),a={id:i.id,name:i.name,goal:i.goal,startDate:i.startDate,endDate:i.endDate},s={optionalStats:{...j},features:{...F},theme:J},r=Us();return vs({project:a,entries:e,preferences:s,rewards:r})},Ea=(t,e)=>{const a=[];for(let s=0;s<t.length;s+=e)a.push(t.slice(s,s+e));return a},Js=async t=>{if(!(!u||!f||!t||!le))try{const{error:e}=await u.from(de).delete().eq("project_id",t);if(te(e,"reset"))return;if(e)throw e;const a=$(t);if(!a.length)return;const s=a.map(n=>{if(!n?.id||!n?.date)return null;const o=qt.get(n.id)||null,d=n.unlockedAt||n.unlocked_at||(n.date?new Date(`${n.date}T00:00:00Z`).toISOString():new Date().toISOString());return Da({project_id:t,reward_date:n.date,reward_id:n.id,reward_pack:n.pack||o?.pack||"kitten",message:n.message!==void 0?n.message:o?.message??null,unlocked_at:d})}).filter(Boolean);if(!s.length)return;const r=Ea(s,500);for(const n of r){if(!n.length)continue;const{error:o}=await u.from(de).insert(n);if(te(o,"save"))return;if(o)throw o}}catch(e){throw te(e,"save"),e}},Vs=async(t,e)=>{if(!u||!f)return;const a=t?.id||i?.id;if(a)try{if(await u.from("projects").upsert({id:a,user_id:f.id,name:t.name,goal:t.goal,start_date:t.startDate,end_date:t.endDate,updated_at:new Date().toISOString()},{onConflict:"id"}),await u.from("entries").delete().eq("project_id",a),e.length){const r=e.map(d=>{const l=k(d.timestamp);return l?{project_id:a,entry_date:l,delta:d.delta}:null}).filter(Boolean).reduce((d,l)=>{const c=d.get(l.entry_date)||0;return d.set(l.entry_date,c+l.delta),d},new Map),n=Array.from(r.entries()).map(([d,l])=>({project_id:a,entry_date:d,delta:l})),o=Ea(n,500);for(const d of o){if(!d.length)continue;const{error:l}=await u.from("entries").insert(d);if(l)throw l}}await Js(a),await ge()}catch(s){throw console.error("Unable to sync backup to Supabase.",s),s}},Hs=async()=>{try{fe&&(fe.disabled=!0),u&&f&&(await be(),await zt());const t=Ks(),a=`wordtracker-backup-${k(new Date)}.json`;Es(t,a),window.alert("Backup exported successfully.")}catch(t){console.error("Unable to export data.",t),window.alert("Unable to export data. Please try again.")}finally{fe&&(fe.disabled=!1)}},Ys=async t=>{const e=Ws(t.project),a=zs(t.entries),s=$s(t.preferences),r={id:i?.id||e.id||K().id,name:e.name,goal:e.goal,startDate:e.startDate,endDate:e.endDate};i=Rt(r),ke(i),ie(),g.replaceState({total:a.length?a[a.length-1].newTotal:0,entries:a}),Object.keys(ce).forEach(l=>{const c=Object.prototype.hasOwnProperty.call(s.optionalStats,l)?s.optionalStats[l]!==!1:ce[l];Le(l,c,{syncLocal:!0,syncRemote:!1})}),Object.keys(ue).forEach(l=>{const c=Object.prototype.hasOwnProperty.call(s.features,l)?s.features[l]!==!1:ue[l];_e(l,c,{syncLocal:!0,syncRemote:!1})}),ve(s.theme,{persistLocal:!0,persistRemote:!1});const n=typeof t.rewards=="object"&&t.rewards!==null?t.rewards:{},o=[];Object.entries(n).forEach(([,l])=>{!l||typeof l!="object"||Object.entries(l).forEach(([c,h])=>{!h||typeof h!="object"||o.push({...h,date:c})})});const d={};if(i.id){const l={};o.forEach(c=>{if(!c?.date)return;const{date:h,...m}=c;l[h]=m}),Object.keys(l).length&&(d[i.id]=l)}xt(d),Q=ka(i.id,o),it(Q),Ve(),N(),ie(),u&&f&&(await Vs(i,a),await be(),await zt()),f&&await ge()},Xs=async t=>{const e=t.target.files?.[0]||null;if(t.target.value="",!!e)try{const a=await js(e),{valid:s,errors:r}=Ts(a);if(!s){window.alert(`Unable to import backup:
${r.join(`
`)}`);return}if(a.metadata?.version&&a.metadata.version!==At&&!window.confirm(`This backup was created with version ${a.metadata.version}, which differs from the current format (${At}). Continue with import?`)||!window.confirm("Importing data will overwrite your current progress. Make sure you exported a backup first. Continue?"))return;await Ys(a),window.alert("Backup imported successfully.")}catch(a){console.error("Unable to import data.",a),window.alert("Unable to import data. Please verify the file and try again.")}},Zs=async()=>{g.replaceState({total:0,entries:[]}),g.reset(),xt({}),Object.entries(ce).forEach(([a,s])=>{Le(a,s,{syncLocal:!0,syncRemote:!1})}),Object.entries(ue).forEach(([a,s])=>{_e(a,s,{syncLocal:!0,syncRemote:!1})});const t=K(),e={id:i?.id||t.id,name:t.name,goal:t.goal,startDate:t.startDate,endDate:t.endDate};if(i=Rt(e),ke(i),ie(),ve("classic",{persistLocal:!0,persistRemote:!1}),Ve(),N(),u&&f&&i?.id)try{await u.from("entries").delete().eq("project_id",i.id),await u.from("projects").upsert({id:i.id,user_id:f.id,name:i.name,goal:i.goal,start_date:i.startDate,end_date:i.endDate,updated_at:new Date().toISOString()},{onConflict:"id"}),await u.from(de).delete().eq("project_id",i.id),await u.from("preferences").delete().eq("user_id",f.id)}catch(a){throw console.error("Unable to reset Supabase data.",a),a}f&&await ge()},Qs=async()=>{if(!window.confirm("Resetting will permanently delete your progress. Export a backup before continuing."))return;const e=window.prompt("Type RESET to confirm you want to delete all data.");if(!(!e||e.trim().toUpperCase()!=="RESET"))try{await Zs(),window.alert("All data has been reset.")}catch(a){console.error("Unable to reset data.",a),window.alert("Unable to reset data completely. Please try again.")}},er=()=>{fe&&(fe.disabled=!1,fe.addEventListener("click",Hs)),ta&&Et&&(ta.addEventListener("click",()=>Et.click()),Et.addEventListener("change",Xs)),aa&&aa.addEventListener("click",Qs),nt&&nt.addEventListener("click",t=>{t.preventDefault(),lr()}),Je&&Je.addEventListener("click",t=>{t.preventDefault(),wr()}),_t&&_t.addEventListener("submit",gr),ra&&ra.addEventListener("click",fr),E&&E.addEventListener("change",()=>{if(!Y||Y.value.trim())return;const t=pt(E.value);Y.value=t?.message||""}),$e&&$e.addEventListener("click",yr),Rs.forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),Kt()})}),Ms.forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),Wt()})}),O&&O.addEventListener("click",t=>{t.preventDefault(),ze&&ze.image&&ot(ze)}),mt()},N=()=>{const t=g.getSnapshot(),e=ma(t,i,new Date),a=ss(e);Ce=e,S&&(S.setStat("totalWords",{value:a.totalWords}),S.setStat("wordsToday",{value:e.highlightToday?`${a.wordsToday} ✓`:a.wordsToday,emphasize:e.highlightToday}),S.setStat("wordsPerDay",{value:a.wordsPerDayRequired}),S.setStat("percentage",{value:a.percentage,hidden:!je("percentage")}),S.setStat("averageWords",{value:a.averageWordsPerDay,hidden:!je("averageWords")||a.averageWordsPerDay==="—"}),S.setStat("wordsRemaining",{value:a.wordsRemaining,hidden:!je("wordsRemaining")}),S.setStat("bestDay",{value:a.bestDay,hidden:!je("bestDay")||a.bestDay==="—"}),S.setStat("currentStreak",{value:a.currentStreak,emphasize:e.currentStreak>0,hidden:!je("currentStreak")}),S.setStat("projectedFinish",{value:a.projectedFinish,hidden:!je("projectedFinish")||a.projectedFinish==="—"})),oe&&q("newProgressSummary")&&oe.setProgress({percentage:a.percentage,wordsLabel:a.progressWordsLabel,paceLabel:a.paceLabel,paceState:e.paceState}),H&&H.update({snapshot:t,project:i}),Xe(e),br(e),window.wordTrackerUI&&window.wordTrackerUI.newLayout&&window.wordTrackerUI.newLayout.setDayProgress(e.headerLabel)},tr=()=>{const t=document.querySelector(U.wordEntry),e=document.querySelector(U.wordEntryLegacy);t&&t.removeAttribute("hidden"),e&&e.setAttribute("hidden",""),A||(A=za()),window.wordTrackerUI=window.wordTrackerUI||{},window.wordTrackerUI.wordEntry=Object.freeze(Bs()),N()},ar=()=>{const t=document.querySelector(U.wordEntry),e=document.querySelector(U.wordEntryLegacy);t&&t.setAttribute("hidden",""),e&&e.removeAttribute("hidden"),A&&(A.destroy(),A=null),window.wordTrackerUI&&window.wordTrackerUI.wordEntry&&delete window.wordTrackerUI.wordEntry},sr=()=>{S||(S=Ka()),S&&(window.wordTrackerUI=window.wordTrackerUI||{},window.wordTrackerUI.sidebar=Object.freeze(Gs()))},rr=()=>{S=null,window.wordTrackerUI&&window.wordTrackerUI.sidebar&&delete window.wordTrackerUI.sidebar},nr=()=>{oe||(oe=os()),oe&&(window.wordTrackerUI=window.wordTrackerUI||{},window.wordTrackerUI.progressSummary=Object.freeze(Os()))},or=()=>{oe=null,window.wordTrackerUI&&window.wordTrackerUI.progressSummary&&delete window.wordTrackerUI.progressSummary},ir=()=>{H||(H=us()),H&&(window.wordTrackerUI=window.wordTrackerUI||{},window.wordTrackerUI.graph=Object.freeze(xs()))},dr=()=>{H&&(H.destroy(),H=null),window.wordTrackerUI&&window.wordTrackerUI.graph&&delete window.wordTrackerUI.graph},Bt=()=>{Lt&&(M||(M=Ls()),M&&nt&&(typeof M.registerTrigger=="function"&&M.registerTrigger(nt),typeof M.refreshTriggers=="function"&&M.refreshTriggers()))},lr=()=>{Bt(),Ta(),M?.open()},ja=t=>{t.key==="Escape"&&Wt()},ot=t=>{if(!(!me||!t||!t.image)){if(Ue&&(Ue.src=t.image,Ue.alt=t.label||t.name||"Reward image"),jt&&(jt.textContent=t.label||t.name||"Reward preview"),na){const e=t.date?`Unlocked ${Sa.format(new Date(t.date))}. `:"";na.textContent=`${e}${t.message||""}`.trim()}me.removeAttribute("hidden"),jt?.focus(),document.addEventListener("keydown",ja)}},Wt=()=>{me&&(me.setAttribute("hidden",""),Ue&&(Ue.removeAttribute("src"),Ue.removeAttribute("alt")),document.removeEventListener("keydown",ja))},Ta=()=>{if(!Lt)return;Lt.querySelectorAll(".gallery-card").forEach(e=>{e.tabIndex=0,e.onclick=a=>{a.preventDefault();const s={id:e.dataset.rewardId,image:e.dataset.rewardImage,label:e.dataset.rewardLabel,message:e.dataset.rewardMessage,date:e.dataset.rewardDate};ot(s)},e.onkeydown=a=>{if(a.key==="Enter"||a.key===" "){a.preventDefault();const s={id:e.dataset.rewardId,image:e.dataset.rewardImage,label:e.dataset.rewardLabel,message:e.dataset.rewardMessage,date:e.dataset.rewardDate};ot(s)}}})},oa=()=>{W&&W.setAttribute("hidden",""),he&&he.removeAttribute("hidden"),R&&(R.hidden=!0,R.removeAttribute("src"),R.removeAttribute("alt")),ze=null,O&&(O.disabled=!0,O.dataset.rewardId="",O.dataset.rewardImage="",O.dataset.rewardLabel="",O.dataset.rewardMessage="")},cr=t=>{W&&(W.removeAttribute("hidden"),he&&he.setAttribute("hidden",""),R&&(t.image?(R.src=t.image,R.alt=t.label||"Daily reward image",R.hidden=!1,R.style.width="100%",R.style.height="100%",R.style.objectFit="cover"):(R.hidden=!0,R.removeAttribute("src"),R.removeAttribute("alt"))),sa&&(sa.textContent=t.message||"Keep writing to unlock more kittens!"),ze=t,W&&(W.dataset.rewardId=t.id||"",W.dataset.rewardImage=t.image||"",W.dataset.rewardLabel=t.label||t.name||"Reward",W.dataset.rewardMessage=t.message||""),O&&(O.dataset.rewardId=t.id||"",O.dataset.rewardImage=t.image||"",O.dataset.rewardLabel=t.label||t.name||"Reward",O.dataset.rewardMessage=t.message||"",O.disabled=!t.image))},it=t=>{Bt(),M&&(M.setRewards(t||[]),Ta())},Da=(t={})=>{const e={};return Object.entries(t).forEach(([a,s])=>{s!==void 0&&(e[a]=s)}),e},ur=t=>{if(!t)return!1;const e=String(t.code||"");if(new Set(["PGRST103","PGRST301","PGRST404","42P01"]).has(e))return!0;const s=String(t.message||"");if(!s)return!1;const r=s.toLowerCase();return!r.includes("reward_history")&&!r.includes(de)?!1:r.includes("does not exist")||r.includes("not exist")||r.includes("missing")||r.includes("undefined table")},te=(t,e)=>t?ur(t)?(le&&(le=!1,console.warn(`Supabase reward sync disabled; '${de}' table is unavailable.`)),!0):(console.error(`Unable to ${e} reward data`,t),!1):!1,Aa=async(t,e)=>{if(!u||!f||!i?.id||!le||!t||!e?.id)return;const a=qt.get(e.id)||null,s=Da({project_id:i.id,reward_date:t,reward_id:e.id,reward_pack:e.pack||a?.pack||"kitten",message:e.message!==void 0?e.message:a?.message??null,unlocked_at:e.unlockedAt||new Date().toISOString()});try{const{error:r}=await u.from(de).upsert(s,{onConflict:"project_id,reward_date"});te(r,"save")}catch(r){te(r,"save")}},Ua=async t=>{if(!(!u||!f||!i?.id||!le||!t))try{const{error:e}=await u.from(de).delete().eq("project_id",i.id).eq("reward_date",t);te(e,"delete")}catch(e){te(e,"delete")}},zt=async()=>{if(!u||!f||!i?.id||!le)return $(i?.id);try{const{data:t,error:e}=await u.from(de).select("*").eq("project_id",i.id).order("reward_date",{ascending:!0});if(e)return te(e,"load"),$(i.id);if(!Array.isArray(t))return $(i.id);const a=t.map(s=>({id:s.reward_id||s.rewardId,date:s.reward_date||s.rewardDate,message:s.message??s.reward_message??s.rewardMessage??null,unlockedAt:s.unlocked_at||s.unlockedAt||null}));return Q=ka(i.id,a),it(Q),Q}catch(t){return te(t,"load"),$(i?.id)}},hr=()=>!!(C&&!C.hasAttribute("hidden")),Xe=(t=null)=>{if(!I)return;const e=q("rewardsSystem"),a=pe("rewardsSystem");if(!e||!a){I.setAttribute("hidden",""),I.classList.add("sidebar__section--hidden"),I.style.display="none",he&&he.setAttribute("hidden","");return}I.removeAttribute("hidden"),I.classList.remove("sidebar__section--hidden"),I.style.removeProperty("display");const s=t||Ce||ma(g.getSnapshot(),i,new Date);if(!i?.id){Q=[],oa(),it([]);return}const r=Fs({projectId:i.id,metrics:s,today:new Date});Q=Array.isArray(r?.rewards)?r.rewards:[],it(Q),r?.reward?(cr(r.reward),r.unlockedToday&&r.date&&Aa(r.date,r.reward)):oa(),hr()&&gt()},mt=()=>{E&&E.options.length!==Nt.length&&(E.innerHTML="",Nt.forEach(t=>{const e=document.createElement("option");e.value=t.id,e.textContent=t.label,E.appendChild(e)}))},pt=t=>qt.get(t)||null,mr=(t=k(new Date))=>{if(_t&&(ne.editingDate=null,Ne&&(Ne.value=t||""),E&&E.options.length&&(E.value=E.options[0].value),Y)){const e=E?pt(E.value):null;Y.value=e?.message||""}},pr=t=>{if(mt(),Ne&&(Ne.value=t.date||""),E&&t.id&&(E.value=t.id),Y){const e=pt(t.id);Y.value=t.message||e?.message||""}ne.editingDate=t.date||null},gt=()=>{if(!$e)return;const t=i?.id?$(i.id):[];if($e.innerHTML="",!t.length){rt&&rt.removeAttribute("hidden");return}rt&&rt.setAttribute("hidden",""),t.forEach(e=>{const a=document.createElement("div");a.className="rewards-admin__row",a.dataset.date=e.date,a.dataset.rewardDate=e.date||"",a.dataset.rewardId=e.id||"",a.dataset.rewardImage=e.image||"",a.dataset.rewardLabel=e.label||e.name||e.id||"",a.dataset.rewardMessage=e.message||"";const s=document.createElement("div");if(s.className="rewards-admin__preview",e.image){const m=document.createElement("img");m.src=e.image,m.alt=e.label||e.name||"Reward image",s.appendChild(m)}else s.textContent=e.emoji||"✨";const r=document.createElement("div");r.className="rewards-admin__details";const n=document.createElement("p");n.className="rewards-admin__title",n.textContent=e.label||e.name||e.id,r.appendChild(n);const o=document.createElement("p");o.className="rewards-admin__date";const d=Se(e.date);if(o.textContent=d?Sa.format(d):e.date,r.appendChild(o),e.message){const m=document.createElement("p");m.className="rewards-admin__message",m.textContent=e.message,r.appendChild(m)}const l=document.createElement("div");l.className="rewards-admin__actions";const c=document.createElement("button");c.type="button",c.className="link-button",c.dataset.adminRewardEdit=e.date,c.textContent="Edit",l.appendChild(c);const h=document.createElement("button");h.type="button",h.className="link-button action-list__item--danger",h.dataset.adminRewardDelete=e.date,h.textContent="Delete",l.appendChild(h),a.appendChild(s),a.appendChild(r),a.appendChild(l),$e.appendChild(a)})},gr=t=>{if(t.preventDefault(),!i?.id){window.alert("No active project.");return}if(!Ne||!E)return;const e=Se(Ne.value),a=e?k(e):null;if(!a){window.alert("Please provide a valid date.");return}const s=E.value;if(!s){window.alert("Please select a reward.");return}const r=Y?.value?.trim()||void 0;try{ne.editingDate&&ne.editingDate!==a&&(ba(i.id,ne.editingDate),Ua(ne.editingDate));const n=Cs({projectId:i.id,dateKey:a,rewardId:s,message:r});gt(),Xe(),Aa(a,n),ne.editingDate=null}catch(n){console.error("Unable to save reward.",n),window.alert("Unable to save reward.")}},fr=t=>{if(t.preventDefault(),!E||!Y)return;const e=pt(E.value);Y.value=e?.message||""},yr=t=>{const e=t.target.closest(".rewards-admin__preview");if(e){const r=e.closest(".rewards-admin__row");if(!r)return;const n={id:r.dataset.rewardId,image:r.dataset.rewardImage,label:r.dataset.rewardLabel,message:r.dataset.rewardMessage,date:r.dataset.rewardDate};n.image&&ot(n);return}const a=t.target.closest("[data-admin-reward-edit]");if(a){const r=a.dataset.adminRewardEdit,o=(i?.id?$(i.id):[]).find(d=>d.date===r);o&&pr(o);return}const s=t.target.closest("[data-admin-reward-delete]");if(s){const r=s.dataset.adminRewardDelete;if(!r||!window.confirm(`Remove reward for ${r}?`))return;ba(i?.id,r),Ua(r),gt(),Xe()}},$t=t=>{t.key==="Escape"&&(t.preventDefault(),Kt())},wr=()=>{if(!Je)return;if(!pe("devFeatures")){window.alert("Development tools are disabled. Enable them in Settings > Features.");return}if(!C)return;mt(),mr(),gt(),C.removeAttribute("hidden"),C.querySelector("#rewards-admin-title")?.focus(),document.addEventListener("keydown",$t)},Kt=()=>{C&&(C.setAttribute("hidden",""),ne.editingDate=null,document.removeEventListener("keydown",$t))},br=t=>{if(!(!z||!q("bookComparisons"))){if(!pe("bookComparisons")){z.update({totalWords:Number.NaN});return}Ct.length&&z.update({totalWords:t.totalWords})}},kr=()=>{if(!pe("devFeatures")){window.alert("Development tools are disabled. Enable them in Settings > Features.");return}We||(We=vr()),We?.open()},Fa=t=>{Fe&&(Fe.hidden=!t),Je&&(Je.hidden=!t),t||Kt()},Sr=()=>{const e=g.getSnapshot().entries||[];let a=k(i?.startDate),s=k(i?.endDate);if(!a||!s)if(e.length){const l=[...e].sort((c,h)=>c.timestamp-h.timestamp);a=a||k(l[0].timestamp),s=s||k(l[l.length-1].timestamp)}else{const c=k(new Date);a=a||c,s=s||c}const r=w(a),n=w(s);if(!r||!n)return a?[a]:[];const o=[];let d=r;for(;d&&d<=n;){const l=k(d);l&&o.push(l),d=Mt(d,1)}return o},vr=()=>{const t=document.querySelector("[data-entries-modal]");if(!t)return null;const e=t.querySelector("[data-entries-grid]"),a=Array.from(t.querySelectorAll("[data-entries-dismiss]")),s=t.querySelector("[data-entries-save]");if(!e||!s)return null;const r={timeline:[],values:{}},n=()=>{e.innerHTML="";const c=new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric",year:"numeric"});r.timeline.forEach(h=>{const m=document.createElement("div");m.className="entries-row";const y=document.createElement("div");y.className="entries-row__label";const B=Za(h)||Se(h);y.textContent=B?c.format(B):h;const T=document.createElement("input");T.type="number",T.className="entries-row__input",T.value=r.values[h]??0,T.dataset.entryDate=h,m.append(y,T),e.appendChild(m)})},o=()=>{const c=g.getSnapshot(),h=Ot(c.entries),m=new Map(h.map(y=>[y.date,y.delta]));r.timeline=Sr(),r.values={},r.timeline.forEach(y=>{r.values[y]=m.get(y)??0}),n()},d=()=>{t.setAttribute("hidden","")};a.forEach(c=>c.addEventListener("click",d)),e.addEventListener("input",c=>{const h=c.target;if(!(h instanceof HTMLInputElement))return;const m=h.dataset.entryDate;if(!m)return;const y=Number(h.value);r.values[m]=Number.isFinite(y)?y:0});const l=async()=>{if(!u||!f||!i?.id){window.alert("Sign in with development tools enabled to edit entries.");return}const c=r.timeline.map(h=>({project_id:i.id,entry_date:h,delta:Number(r.values[h])||0})).filter(h=>h.delta!==0);try{const{error:h}=await u.from("entries").delete().eq("project_id",i.id);if(h)throw h;if(c.length){const{error:m}=await u.from("entries").insert(c);if(m)throw m}await be(),d()}catch(h){console.error("Unable to apply entry changes",h),window.alert("Could not save the updated entries. Please try again.")}};return s.addEventListener("click",l),{open(){o(),t.removeAttribute("hidden"),t.querySelector("#entries-modal-title")?.focus()},close:d}},Ca=()=>{if(!pe("bookComparisons")){Jt();return}z||(z=ks()),fs().then(t=>{Ct=t||[],z&&(z.setBooks(Ct),Ce&&z.update({totalWords:Ce.totalWords}))}).catch(t=>{console.warn("Unable to load book comparisons data",t)})},Jt=()=>{z&&(z.destroy(),z=null)};Fe&&Fe.addEventListener("click",kr);const Er=(t,e)=>{Le(t,e),N()},jr=(t,e)=>{_e(t,e)},Tr=t=>{ve(t)},Dr=({name:t,startDate:e,endDate:a,goal:s})=>{const r=(t||"").trim(),n=(e||"").trim(),o=(a||"").trim(),d=Se(n),l=Se(o),c=Number(s),h=k(d),m=k(l);if(!r)return{success:!1,message:"Please enter a project name."};if(!d||!l||Number.isNaN(d.valueOf())||Number.isNaN(l.valueOf()))return{success:!1,message:"Please provide valid start and end dates."};if(!h||!m)return{success:!1,message:"Dates must be valid calendar days."};if(l<d)return{success:!1,message:"End date must be on or after the start date."};if(!Number.isFinite(c)||c<=0)return{success:!1,message:"Goal must be a positive number."};const y=Math.round(c);if(u&&f&&i?.id)return u.from("projects").upsert({id:i.id,user_id:f.id,name:r,goal:y,start_date:h,end_date:m,updated_at:new Date().toISOString()},{onConflict:"id"}).select().single().then(({data:T,error:V})=>V?(console.error("Unable to save project",V),{success:!1,message:"Could not save project. Please try again."}):(i={id:T.id,name:T.name,goal:T.goal,startDate:T.start_date,endDate:T.end_date},ke(i),ie(),p&&p.setProject(i),N(),{success:!0,message:"Project updated."}));i=Rt({...i,name:r,startDate:h,endDate:m,goal:y});const B=document.querySelector(U.projectName);return B&&(B.textContent=i.name),p&&p.setProject(i),N(),{success:!0,message:"Project updated."}},Ar=()=>{if(!p&&(p=ms({onStatToggle:Er,onProjectSubmit:Dr,onFeatureToggle:jr,onThemeChange:Tr,initialTheme:J}),p)){const t=p.getSelectedStats();Object.entries(t).forEach(([a])=>{p.setStatToggle(a,j[a]!==!1)});const e=p.getSelectedFeatures?.()||{};Object.entries(e).forEach(([a])=>{p.setFeatureToggle(a,F[a]!==!1)})}p&&(window.wordTrackerUI=window.wordTrackerUI||{},window.wordTrackerUI.settings=Object.freeze(qs()),p.setProject(i),p.setTheme(J),Object.entries(F).forEach(([t,e])=>{p.setFeatureToggle(t,e!==!1)})),N()},Ur=()=>{p&&(p.close(),p.destroy(),p=null),Object.keys(j).forEach(t=>{j[t]=!0}),window.wordTrackerUI&&window.wordTrackerUI.settings&&delete window.wordTrackerUI.settings,N()},Na=()=>{!q("rewardsSystem")||!pe("rewardsSystem")||(Bt(),mt(),I&&(I.removeAttribute("hidden"),I.classList.remove("sidebar__section--hidden"),I.style.removeProperty("display")),Xe(Ce))},Pa=()=>{I&&(I.setAttribute("hidden",""),I.classList.add("sidebar__section--hidden"),I.style.display="none"),W&&W.setAttribute("hidden",""),he&&he.setAttribute("hidden",""),Q=[],M&&(M.setRewards([]),typeof M.close=="function"&&M.close()),C&&C.setAttribute("hidden",""),Wt(),document.removeEventListener("keydown",$t)},ge=async()=>{if(!u||!f)return;const t={};Object.keys(ce).forEach(o=>{t[o]=j[o]!==!1});const e={};Object.keys(ue).forEach(o=>{e[o]=F[o]!==!1});const a=(o=!0)=>{const d={user_id:f.id,optional_stats:t,features:e,updated_at:new Date().toISOString()};return o&&(d.theme=J),d},s=async o=>u.from("preferences").upsert(a(o),{onConflict:"user_id"});let r=ea,{error:n}=await s(r);if(n&&r&&n.code==="PGRST204"){ea=!1;const o=await s(!1);o.error&&console.error("Unable to persist preferences",o.error);return}n&&console.error("Unable to persist preferences",n)},be=async()=>{if(!u||!f||!i?.id){N();return}const{data:t,error:e}=await u.from("entries").select("*").eq("project_id",i.id).order("entry_date",{ascending:!0}).order("created_at",{ascending:!0});if(e){console.error("Unable to load entries",e);return}let a=0;const s=(t||[]).map(r=>{const n=w(r.entry_date),o=n?n.getTime():Date.now(),d={id:r.id,mode:"add",delta:r.delta,previousTotal:a,newTotal:a+r.delta,timestamp:o};return a+=r.delta,d});g.replaceState({total:a,entries:s}),N()},Fr=()=>{g.addWords=async t=>{if(!u||!f||!i?.id)return we.addWords(t);const e=Number(t);if(!Number.isFinite(e)||e===0)return g.getSnapshot();const a=k(new Date);if(!a)return console.error("Unable to derive date key for entry insertion."),g.getSnapshot();const{error:s}=await u.from("entries").insert({project_id:i.id,entry_date:a,delta:e});if(s)throw console.error("Unable to add entry",s),s;return await be(),g.getSnapshot()},g.setTotal=async t=>{if(!u||!f||!i?.id)return we.setTotal(t);const e=g.getSnapshot(),a=Number(t);if(!Number.isFinite(a))return e;const s=a-e.total;if(s===0)return e;const r=k(new Date);if(!r)return console.error("Unable to derive date key for total update."),e;const{error:n}=await u.from("entries").insert({project_id:i.id,entry_date:r,delta:s});if(n)throw console.error("Unable to set total",n),n;return await be(),g.getSnapshot()},g.undoLastEntry=async()=>{if(!u||!f||!i?.id)return we.undoLastEntry();try{const{data:t,error:e}=await u.from("entries").select("id").eq("project_id",i.id).order("entry_date",{ascending:!1}).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(e)throw e;if(!t)return g.getSnapshot();const{error:a}=await u.from("entries").delete().eq("id",t.id);if(a)throw a;return await be(),g.getSnapshot()}catch(t){throw console.error("Unable to undo last entry",t),t}}},Cr=()=>{g.addWords=we.addWords,g.setTotal=we.setTotal,g.undoLastEntry=we.undoLastEntry},La=t=>{qe&&(t?(qe.removeAttribute("inert"),qe.removeAttribute("aria-hidden")):(qe.setAttribute("inert",""),qe.setAttribute("aria-hidden","true"))),document.body&&(document.body.style.overflow=t?"":"hidden"),vt&&(t?(vt.removeAttribute("hidden"),st&&(st.textContent=t.email||"Signed in"),Ge&&(Ge.value="")):(vt.setAttribute("hidden",""),st&&(st.textContent=""))),Ae&&(t?Ae.setAttribute("hidden",""):(Ae.removeAttribute("hidden"),G&&(G.textContent=""),window.setTimeout(()=>{Ge&&Ge.focus()},0)))},Nr=async()=>{if(Object.assign(j,ce),Object.assign(F,ue),!u||!f){N();return}const{data:t,error:e}=await u.from("preferences").select("*").eq("user_id",f.id).maybeSingle();if(e&&e.code!=="PGRST116"){console.error("Unable to load preferences",e);return}if(t){const a=t.optional_stats||{};Object.keys(ce).forEach(r=>{Object.prototype.hasOwnProperty.call(a,r)&&(j[r]=a[r]!==!1)});const s=t.features||{};Object.keys(ue).forEach(r=>{Object.prototype.hasOwnProperty.call(s,r)&&(F[r]=s[r]!==!1)}),t.theme?ve(t.theme,{persistLocal:!0,persistRemote:!1}):ve(J,{persistLocal:!0,persistRemote:!1})}else await ge()},Pr=async()=>{if(!u||!f)return i=K(),ke(i),ie(),null;const{data:t,error:e}=await u.from("projects").select("*").eq("user_id",f.id).order("created_at",{ascending:!0}).limit(1).maybeSingle();if(e&&e.code!=="PGRST116")return console.error("Unable to load project",e),null;if(t)i={id:t.id,name:t.name,goal:t.goal,startDate:t.start_date,endDate:t.end_date};else{const a=K(),{data:s,error:r}=await u.from("projects").insert({user_id:f.id,name:a.name,goal:a.goal,start_date:a.startDate,end_date:a.endDate}).select().single();if(r)return console.error("Unable to create project",r),null;i={id:s.id,name:s.name,goal:s.goal,startDate:s.start_date,endDate:s.end_date}}return ke(i),ie(),i},Lr=async()=>{await Pr(),await Nr(),Object.entries(j).forEach(([t,e])=>{Le(t,e,{syncRemote:!1})}),Object.entries(F).forEach(([t,e])=>{_e(t,e,{syncRemote:!1})}),p&&(p.setProject(i),Object.entries(j).forEach(([t,e])=>{p.setStatToggle(t,e!==!1)}),Object.entries(F).forEach(([t,e])=>{p.setFeatureToggle(t,e!==!1)}),p.setTheme(J)),Fr(),await be(),await zt(),Xe(Ce)},_r=()=>{Cr(),we.reset(),Object.assign(j,ce),Object.assign(F,ue),Object.entries(j).forEach(([t,e])=>{Le(t,e,{syncRemote:!1})}),Object.entries(F).forEach(([t,e])=>{_e(t,e,{syncRemote:!1})}),i=K(),ke(i),ie(),xt({}),ve("classic",{persistLocal:!0,persistRemote:!1}),p&&(p.setProject(i),Object.entries(j).forEach(([t,e])=>{p.setStatToggle(t,e!==!1)}),Object.entries(F).forEach(([t,e])=>{p.setFeatureToggle(t,e!==!1)})),N(),Ve(),f&&ge()},It=async t=>{const e=f&&t&&f.id===t.id;if(f=t,La(t),!t){G&&(G.textContent=""),le=!0,_r();return}if(!e){G&&(G.textContent=""),le=!0;try{await Lr()}catch(a){console.error("Unable to load user data",a)}}},Ir=async()=>{if(!u){La(null);return}const{data:t}=await u.auth.getSession();await It(t?.session?.user||null),u.auth.onAuthStateChange(async(e,a)=>{await It(a?.user||null)})},Rr=()=>{if(Qt)return;const t=()=>{N()};window.addEventListener(g.events.entryAdded,t),window.addEventListener(g.events.entryUndone,t),Qt=!0},Ve=()=>{const{body:t}=document;if(!t)return;t.dataset.featureNewLayout=String(Te.newLayout),t.dataset.featureNewWordEntry=String(Te.newWordEntry),t.dataset.featureProgressSummary=String(Te.newProgressSummary),t.dataset.featureRewardsSystem=String(Te.rewardsSystem),t.dataset.featureBookComparisons=String(Te.bookComparisons);const e=document.querySelector(U.newLayoutRoot);e&&(q("newLayout")?(ie(),e.removeAttribute("hidden"),window.wordTrackerUI=window.wordTrackerUI||{},window.wordTrackerUI.newLayout=Object.freeze(_s),sr(),ir()):(e.setAttribute("hidden",""),rr(),dr()),q("newWordEntry")?tr():ar(),q("newProgressSummary")?nr():or(),q("rewardsSystem")?Na():Pa(),q("customizableStats")?Ar():Ur(),q("bookComparisons")&&pe("bookComparisons")?Ca():Jt(),Fa(pe("devFeatures")),N())};Rr();er();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ve):Ve();Pt&&Pt.addEventListener("submit",async t=>{if(t.preventDefault(),!u){G.textContent="Supabase is not configured.";return}const e=Ge?.value.trim();if(!e){G.textContent="Please enter an email address.";return}try{G.textContent="Sending magic link...",at&&(at.disabled=!0);const{error:a}=await u.auth.signInWithOtp({email:e,options:{emailRedirectTo:window.location.origin}});a?G.textContent=a.message:G.textContent="Check your email for the login link."}catch(a){G.textContent="Unable to send login link.",console.error(a)}finally{at&&(at.disabled=!1)}});Is?.addEventListener("click",async t=>{t.preventDefault(),u?await u.auth.signOut():It(null)});Ir();
